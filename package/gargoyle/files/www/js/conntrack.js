/*
 * This program is copyright ï¿½ 2008 Eric Bishop and is distributed under the terms of the GNU GPL
 * version 2.0 with a special clarification/exception that permits adapting the program to
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL.
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function initializeConnectionTable(){httpsPort=uciOriginal.get("httpd_gargoyle","server","https_port"),httpPort=uciOriginal.get("httpd_gargoyle","server","http_port"),setSelectedValue("host_display","hostname"),remoteHttpsPort="",remoteHttpPort="";var e=uciOriginal.getAllSectionsOfType("firewall","remote_accept"),t=0;for(t=0;t<e.length;t++){var n=e[t],r=uciOriginal.get("firewall",n,"local_port"),i=uciOriginal.get("firewall",n,"remote_port"),s=uciOriginal.get("firewall",n,"proto").toLowerCase(),o=uciOriginal.get("firewall",n,"zone").toLowerCase();(o=="wan"||o=="")&&(s=="tcp"||s=="")&&(i=i==""?r:i,r==httpsPort&&r!=""?remoteHttpsPort=i:r==httpPort&&r!=""&&(remoteHttpPort=i))}var u=0;for(u=0;u<qosMarkList.length;u++){var a=parseInt(qosMarkList[u][3].toLowerCase());qosUpMask=qosMarkList[u][0]=="upload"?a:qosUpMask,qosDownMask=qosMarkList[u][0]=="download"?a:qosDownMask,markToQosClass[parseInt(qosMarkList[u][2])]=qosMarkList[u][1]}updateInProgress=!1,timeSinceUpdate=-5e3,setInterval("checkForRefresh()",500)}function checkForRefresh(){timeSinceUpdate+=500,refreshRate=getSelectedValue("refresh_rate"),refreshRate=refreshRate=="never"?timeSinceUpdate+500:refreshRate;if(timeSinceUpdate<0||timeSinceUpdate>=refreshRate)timeSinceUpdate=0,updateConnectionTable()}function getHostDisplay(e){var t=getSelectedValue("host_display"),n=e;return t=="hostname"&&ipToHostname[e]!=null&&(n=ipToHostname[e],n=n.length<25?n:n.substr(0,22)+"..."),n}function updateConnectionTable(){if(!updateInProgress){updateInProgress=!0;var e="cat /proc/net/nf_conntrack",t=getParameterDefinition("commands",e)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),n=function(e){if(e.readyState==4){var t=getSelectedValue("bw_units"),n=e.responseText.split(/[\n\r]+/),r=new Array,i;for(i=0;n[i].match(/^Success/)==null;i++){var s=n[i];try{var o=s.split(/[\t ]+/)[2],u=s.match(/src=([^ \t]*)[\t ]+/)[1],a=s.match(/sport=([^ \t]*)[\t ]+/)[1],f=s.match(/dst=([^ \t]*)[\t ]+/)[1],l=s.match(/dport=([^ \t]*)[\t ]+/)[1],c=s.match(/bytes=([^ \t]*)[\t ]+/)[1],h=s.match(/mark=/)?parseInt(s.match(/mark=([^ \t]*)[\t ]+/)[1]):"",p=s.match(/l7proto=/)?s.match(/l7proto=([^ \t]*)[\t ]+/)[1]:"",d=s.match(/src=([^ \t]*)[\t ]+.*src=([^ \t]*)[\t ]+/)[2],v=s.match(/sport=([^ \t]*)[\t ]+.*sport=([^ \t]*)[\t ]+/)[2],m=s.match(/dst=([^ \t]*)[\t ]+.*dst=([^ \t]*)[\t ]+/)[2],g=s.match(/dport=([^ \t]*)[\t ]+.*dport=([^ \t]*)[\t ]+/)[2],y=s.match(/bytes=([^ \t]*)[\t ]+.*bytes=([^ \t]*)[\t ]+/)[2],b=currentLanIp.lastIndexOf(".");if(u.substr(0,b)!=f.substr(0,b)){m==currentWanIp?(downloadBytes=y,uploadBytes=c,localIp=u,localPort=a,WanIp=d,WanPort=v):(downloadBytes=c,uploadBytes=y,localIp=d,localPort=v,WanIp=m,WanPort=g);var w=[parseInt(uploadBytes)+parseInt(downloadBytes),o,textListToSpanElement([getHostDisplay(WanIp)+":"+WanPort,getHostDisplay(localIp)+":"+localPort]),textListToSpanElement([parseBytes(uploadBytes,t),parseBytes(downloadBytes,t)])];if(qosEnabled){var E=function(e,t){var n=e==""?"":markToQosClass[e&t],r=uciOriginal.get("qos_gargoyle",n,"name");return r==""?"NA":r};w.push(textListToSpanElement([E(qosUpMask,h),E(qosDownMask,h)]))}w.push(p),r.push(w)}}catch(S){}}var x=function(e,t){return parseInt(t[0])-parseInt(e[0])};r.sort(x);var T;for(T=0;T<r.length;T++)r[T].shift();var N=["Proto","WAN Host/LAN Host","Bytes Up/Down"];qosEnabled&&N.push("Qos Up/Down"),N.push("L7 Proto");var C=createTable(N,r,"connection_table",!1,!1);if(r.length>0){var k;try{for(k=0;k<5;k++)C.firstChild.firstChild.childNodes[k].style.textAlign="left"}catch(S){}}var L=document.getElementById("connection_table_container");L.firstChild!=null&&L.removeChild(L.firstChild),L.appendChild(C),updateInProgress=!1}};runAjax("POST","utility/run_commands.sh",t,n)}}var updateInProgress,timeSinceUpdate,httpsPort="",httpPort="",remoteHttpsPort="",remoteHttpPort="",qosUpMask="",qosDownMask="",markToQosClass=[];