/*
 * This program is copyright 2008-2011 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function initializePlotsAndTable(){updateInProgress=!1,initFunction()}function initFunction(){pieChart=document.getElementById("pie_chart"),pieChart!=null?(doUpdate(),setInterval(doUpdate,2e3)):setTimeout(initFunction,50)}function getEmbeddedSvgPlotFunction(e){return windowElement=getEmbeddedSvgWindow(e),windowElement!=null?windowElement.setPieChartData:null}function getHostDisplay(e){var t=getSelectedValue("host_display"),n=e;return t=="hostname"&&ipToHostname[e]!=null&&(n=ipToHostname[e],n=n.length<25?n:n.substr(0,22)+"..."),n}function getHostList(e){var t=[],n=0;for(n=0;n<e.length;n++)t.push(getHostDisplay(e[n]));return t}function doUpdate(){if(!updateInProgress&&pieChart!=null){var e=getSelectedValue("time_frame"),t="",n="",r=0;for(r=0;r<monitorNames.length;r++){var i=monitorNames[r];i.indexOf(e)>=0&&(i.indexOf("upload")>=0&&(n=""+i),i.indexOf("download")>=0&&(t=""+i))}var s=t+" "+n,o=getParameterDefinition("monitor",s)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),u=function(e){var t=null;if(e.readyState==4){if(!e.responseText.match(/ERROR/)){var r=parseMonitors(e.responseText),i=1,s=0,o=0,u=[];for(s=0;s<r.length;s++){var a=r[s];for(S in a){var f=a[S][0];o=parseInt(a[S][1]),i=f.length>i?f.length:i,u[S]=1}}idList=[];for(S in u)idList.push(S);var l=getSelectedValue("time_interval"),c=getSelectedText("time_interval"),h=[],p=[],d=new Date;d.setTime(o*1e3),d.setUTCMinutes(d.getUTCMinutes()+tzMinutes);var v=d.valueOf()/1e3;timeFrameIntervalData=[];var m=[],g;for(g=0;g<i;g++){var y=[],s,b=[];for(s=0;s<r.length;s++){var a=r[s],w=[],E;for(E=0;E<idList.length;E++){var S=idList[E];S=S==currentWanIp?currentLanIp:S;var x=0;if(a[S]!=null){var f=a[S][0];f!=null&&(x=f[f.length-1-g],x=x==null?0:parseFloat(x))}w.push(x),b[E]=b[E]==null?x:b[E]+x}y.push(w)}y.unshift(b),timeFrameIntervalData.push(y);var T=["January","February","March","April","May","June","July","August","September","October","November","December"],N=function(e){var t=""+e;return t=t.length==1?"0"+t:t,t};d.setTime(parseInt(v)*1e3);var C="";if(n.match("minute"))C=""+N(d.getUTCHours())+":"+N(d.getUTCMinutes()),d.setUTCMinutes(d.getUTCMinutes()-1);else if(n.match("hour"))C=""+N(d.getUTCHours())+":"+N(d.getUTCMinutes()),d.setUTCHours(d.getUTCHours()-1);else if(n.match("day"))C=T[d.getUTCMonth()]+" "+d.getUTCDate(),d.setUTCDate(d.getUTCDate()-1);else if(n.match("month"))C=T[d.getUTCMonth()]+" "+d.getUTCFullYear(),d.setUTCMonth(d.getUTCMonth()-1);else{var k=n.split(/-/),i=k.pop(),L=k.pop();parseInt(L)>=2419200?C=T[d.getUTCMonth()]+" "+d.getUTCFullYear()+" "+N(d.getUTCHours())+":"+N(d.getUTCMinutes()):parseInt(L)>=86400?C=T[d.getUTCMonth()]+" "+N(d.getUTCHours())+":"+N(d.getUTCMinutes()):C=""+N(d.getUTCHours())+":"+N(d.getUTCMinutes()),d.setTime(d.getTime()-parseInt(L)*1e3)}p.push(C),h.push(""+g),v=d.valueOf()/1e3}setAllowableSelections("time_interval",h,p),l==null||l==0?setSelectedValue("time_interval","0"):setSelectedText("time_interval",c)}updateInProgress=!1,resetDisplayInterval()}};runAjax("POST","utility/load_bandwidth.sh",o,u)}}function resetTimeFrame(){resetColors=!0,doUpdate()}function resetDisplayInterval(){var e=getEmbeddedSvgPlotFunction("pie_chart");if(e!=null&&pieChart!=null&&!updateInProgress&&timeFrameIntervalData.length>0){updateInProgress=!0;var t=getSelectedValue("time_interval");t=t==null?0:t;var n=timeFrameIntervalData[t],r=e(idList,["Total","Download","Upload"],getHostList(idList),n,0,9,resetColors);resetColors=!1;var i=[],s;for(s=0;s<idList.length;s++)i.push(s);var o=function(e,t){return idList[e]<idList[t]?1:-1};i.sort(o);var u=["Total","Down","Up"],a=[],f;zeroPies=[];for(f=0;f<u.length;f++){s=0;var l=!0;for(s=0;s<idList.length;s++)l=l&&n[f][s]==0;zeroPies.push(l)}var c=[0,0,0];for(s=0;s<i.length;s++){var h=i[s],p=idList[h];p=p==currentWanIp?currentLanIp:p;var d=[getHostDisplay(p)],f,v=!0;for(f=0;f<u.length;f++){var m=parseBytes(n[f][h]);m=m.replace("ytes",""),d.push(m),c[f]=c[f]+n[f][h]}for(f=0;f<u.length;f++){var g=zeroPies[f]?100/idList.length:n[f][h]*100/r[f],y=""+parseInt(g*10)/10+"%";d.push(y)}a.push(d)}a.push(["Sum",parseBytes(c[0]),parseBytes(c[1]),parseBytes(c[2]),"","",""]);var b=["Host"];for(f=0;f<u.length;f++)b.push(u[f]);for(f=0;f<u.length;f++)b.push(u[f]+" %");var w=createTable(b,a,"bandwidth_distribution_table",!1,!1),E=document.getElementById("bandwidth_distribution_table_container");E.firstChild!=null&&E.removeChild(E.firstChild),E.appendChild(w),updateInProgress=!1}}function parseMonitors(e){var t=[[],[]],n=e.split("\n"),r=parseInt(n.shift()),i;for(i=0;i<n.length;i++)if(n[i].length>0){var s=n[i].split(/[\t ]+/)[0];s=s.match(/download/)?0:1;var o=n[i].split(/[\t ]+/)[1];i++;var u=n[i];i++;var a=n[i];i++;var f=n[i];i++;var l=n[i].split(",");o!="COMBINED"&&(t[s][o]=[l,f])}return t}var plotsInitializedToDefaults=!1,updateInProgress=!1,pieChart=null,initialized=!1,timeFrameIntervalData=[],idList=[],resetColors=!1;