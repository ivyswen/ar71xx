/*
 * This program is copyright ï¿½ 2008,2009 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function getEmbeddedSvgSetFunction(e){return windowElement=getEmbeddedSvgWindow(e),windowElement!=null?windowElement.setPieChartData:null}function initializePieCharts(){uploadClassIds=[],downloadClassIds=[],uploadClassNames=[],downloadClassNames=[];var e=[],t=[];for(monitorIndex=0;monitorIndex<monitorNames.length;monitorIndex++){var n=monitorNames[monitorIndex];if(n.match(/qos/)){var r=n.match(/up/),i=n.match(/down/),s=n.split("-");s.shift(),s.shift(),s.pop(),s.pop();var o=s.join("-"),u=uciOriginal.get("qos_gargoyle",o,"name");r&&e[o]==null&&(uploadClassIds.push(o),uploadClassNames.push(u),e[o]=1),i&&t[o]==null&&(downloadClassIds.push(o),downloadClassNames.push(u),t[o]=1)}}uciOriginal.get("qos_gargoyle","upload","total_bandwidth")==""&&(document.getElementById("upload_container").style.display="none"),uciOriginal.get("qos_gargoyle","download","total_bandwidth")==""&&(document.getElementById("download_container").style.display="none"),setTimeout(initializePies,150),setInterval("updatePieCharts()",2e3)}function initializePies(){setUploadPie==null&&(setUploadPie=getEmbeddedSvgSetFunction("upload_pie")),setDownloadPie==null&&(setDownloadPie=getEmbeddedSvgSetFunction("download_pie")),setUploadPie==null||setDownloadPie==null?setTimeout("initializePies()",100):setQosTimeframes()}function setQosTimeframes(){if(!!updateInProgress||setUploadPie==null&&uciOriginal.get("qos_gargoyle","upload","total_bandwidth")!=""||setDownloadPie==null&&uciOriginal.get("qos_gargoyle","download","total_bandwidth")!=""){setTimeout("setQosTimeframes()",100);if(setUploadPie==null||setDownloadPie==null)setUploadPie=getEmbeddedSvgSetFunction("upload_pie"),setDownloadPie=getEmbeddedSvgSetFunction("download_pie")}else updatePieCharts()}function getMonitorId(e,t,n,r,i){var s,o=null,u="",a="";n=="total"?u=i?"total"+t+"B":"total"+t+"A":n.match(/qos/)?(u="qos"+t,a=r):n=="ip"&&(u="bdist"+t);if(n!="none")for(s=0;s<monitorNames.length&&o==null;s++){var f=monitorNames[s];(f.match("up")&&e||f.match("down")&&!e)&&(u==""||f.match(u))&&(a==""||f.match(a))&&(o=f)}return o}function updatePieCharts(){if(!updateInProgress){updateInProgress=!0;var e=["up","down"],t=[];for(directionIndex=0;directionIndex<e.length;directionIndex++){var n=e[directionIndex],r=n=="up"?uploadClassIds:downloadClassIds,i=parseInt(getSelectedValue(n+"_timeframe"));for(classIndex=0;classIndex<r.length;classIndex++)t.push(getMonitorId(n=="up"?!0:!1,i,"qos",r[classIndex],!0))}var s=getParameterDefinition("monitor",t.join(" "))+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),o=function(e){if(e.readyState==4){var n=parseMonitors(e.responseText),r=["up","down"],i=[],s=[],o=[],u=[];for(directionIndex=0;directionIndex<r.length;directionIndex++){var a=r[directionIndex],f=[],l=0,c=[],h=[];for(nameIndex=0;nameIndex<t.length;nameIndex++)if(t[nameIndex].match(a)){var p=0,d=n[t[nameIndex]];if(d!=null){var v=d[0];p=parseInt(v[v.length-1])}f.push(p),l+=p}var m=l==0?!0:!1;if(m){var g;for(g=0;g<f.length;g++)f[g]=1,l++}for(nameIndex=0;nameIndex<f.length;nameIndex++){var y=a.match("up")?uploadClassNames:downloadClassNames;className=y[nameIndex];if(m){var b="("+truncateDecimal(100*(1/f.length))+"%)";c.push(className+" - "+parseBytes(f[nameIndex]-1)+" "+b)}else{var b="("+truncateDecimal(100*f[nameIndex]/l)+"%)";c.push(className+" - "+parseBytes(f[nameIndex])+" "+b)}}i=a.match("up")?f:i,s=a.match("up")?c:s,o=a.match("down")?f:o,u=a.match("down")?c:u}i.length>0&&setUploadPie!=null&&uciOriginal.get("qos_gargoyle","upload","total_bandwidth")!=""&&setUploadPie(i,s),o.length>0&&setDownloadPie!=null&&uciOriginal.get("qos_gargoyle","download","total_bandwidth")!=""&&setDownloadPie(o,u),updateInProgress=!1}};runAjax("POST","utility/load_bandwidth.sh",s,o)}}function parseMonitors(e){var t=new Array,n=e.split("\n"),r=parseInt(n.shift());for(lineIndex=0;lineIndex<n.length;lineIndex++)n[lineIndex].length>0&&(monitorName=n[lineIndex],monitorName=monitorName.replace(/[\t ]+.*$/,""),lineIndex++,lineIndex++,lineIndex++,lastTimePoint=n[lineIndex],lineIndex++,points=n[lineIndex].split(","),t[monitorName]=[points,lastTimePoint]);return t}function parseBytes(e){var t;return e>1099511627776?t=truncateDecimal(e/1099511627776)+"TB":e>1073741824?t=truncateDecimal(e/1073741824)+"GB":e>1048576?t=truncateDecimal(e/1048576)+"MB":e>1024?t=truncateDecimal(e/1024)+"KB":t=e+"B",t}function truncateDecimal(e){return result=""+Math.ceil(e*10)/10,result}var uploadClassIds=[],downloadClassIds=[],uploadClassNames=[],downloadClassNames=[],uploadUpdateInProgress=!1,downloadUpdateInProgress=!1,updateInProgress=!1,setUploadPie=null,setDownloadPie=null;