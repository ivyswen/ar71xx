/*
 * This program is copyright ï¿½ 2008-2010 Eric Bishop and is distributed under the terms of the GNU GPL
 * version 2.0 with a special clarification/exception that permits adapting the program to
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL.
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function saveChanges(){uci=uciOriginal.clone();var e="",t="",n="/etc/init.d/bwmon_gargoyle stop ;\n",r="/etc/init.d/bwmon_gargoyle start ;\n",i="\nif [ -d /usr/data/bwmon/ ] ; then rm /usr/data/bwmon/qos-"+direction+"-* >/dev/null 2>&1 ; fi ;\n",i=i+"if [ -d /tmp/data/bwmon/ ] ; then rm /tmp/data/bwmon/qos-"+direction+"-* >/dev/null 2>&1 ; fi ;\n";direction=="download"&&(uci.set("qos_gargoyle",direction,"qos_monenabled",document.getElementById("qos_monenabled").checked),document.getElementById("use_ptarget_ip").checked==1?uci.set("qos_gargoyle",direction,"ptarget_ip",document.getElementById("ptarget_ip").value):uci.remove("qos_gargoyle",direction,"ptarget_ip"),document.getElementById("use_auto_pinglimit").checked==1?uci.set("qos_gargoyle",direction,"pinglimit",document.getElementById("pinglimit").value):uci.remove("qos_gargoyle",direction,"pinglimit"));var s=document.getElementById("qos_enabled").checked==0,o=direction=="upload"?"download":"upload",u=uciOriginal.get("qos_gargoyle",o,"total_bandwidth"),a=!s||u!="",f=a!=qosEnabled;if(s)qosEnabled&&u==""?(uci.remove("gargoyle","status","qos"),e="/etc/init.d/qos_gargoyle stop\n/etc/init.d/qos_gargoyle disable\n",qosEnabled=!1):e="/etc/init.d/qos_gargoyle start\n",uci.remove("qos_gargoyle",direction,"total_bandwidth"),f&&qosQuotasExist()?e=uci.getScriptCommands(uciOriginal)+"\n"+e+"sh /usr/lib/gargoyle/restart_firewall.sh ;\n":e=uci.getScriptCommands(uciOriginal)+"\n"+n+e+i+r;else if(validateNumeric(document.getElementById("total_bandwidth").value)!=0)t="There is an error in Total Bandwidth field.\n\nCould not update QoS.";else{qosEnabled=!0,preCommands=[],uci.set("gargoyle","status","qos","300"),directionRule=direction+"_rule",oldRuleSections=uciOriginal.getAllSectionsOfType("qos_gargoyle",directionRule);for(sectionIndex=oldRuleSections.length-1;sectionIndex>=0;sectionIndex--)uciOriginal.removeSection("qos_gargoyle",oldRuleSections[sectionIndex]),uci.removeSection("qos_gargoyle",oldRuleSections[sectionIndex]),preCommands.push("uci del qos_gargoyle."+oldRuleSections[sectionIndex]);directionClass=direction+"_class",oldClassSections=uciOriginal.getAllSectionsOfType("qos_gargoyle",directionClass);for(sectionIndex=oldClassSections.length-1;sectionIndex>=0;sectionIndex--)uciOriginal.removeSection("qos_gargoyle",oldClassSections[sectionIndex]),uci.removeSection("qos_gargoyle",oldClassSections[sectionIndex]),preCommands.push("uci del qos_gargoyle."+oldClassSections[sectionIndex]);preCommands.push("uci commit"),uci.set("qos_gargoyle",direction,"total_bandwidth",document.getElementById("total_bandwidth").value),HTMLclassTable=document.getElementById("qos_class_table_container").firstChild,classData=getTableDataArray(HTMLclassTable,!0,!1),percentSum=0;for(classIndex=0;classIndex<classData.length;classIndex++)percent=classData[classIndex][1],percent=percent.substr(0,percent.length-1),classData[classIndex][1]=percent,percentSum+=1*percent;classIds=[];for(classIndex=0;classIndex<classData.length;classIndex++)classId=direction.substr(0,1).toLowerCase()+"class_"+(classIndex+1),className=classData[classIndex][0],classIds[className]=classId,uci.set("qos_gargoyle",classId,"",directionClass),uci.set("qos_gargoyle",classId,"name",className),percent=Math.round(100*(classData[classIndex][1]/percentSum)),percent<1&&(percent=1),uci.set("qos_gargoyle",classId,"percent_bandwidth",percent),minBandwidth=classData[classIndex][2],minBandwidth!="zero"&&uci.set("qos_gargoyle",classId,"min_bandwidth",minBandwidth),maxBandwidth=classData[classIndex][3],maxBandwidth!="nolimit"&&uci.set("qos_gargoyle",classId,"max_bandwidth",maxBandwidth),classData[classIndex][4]=="Yes"&&uci.set("qos_gargoyle",classId,"minRTT","Yes");uci.set("qos_gargoyle",direction,"default_class",classIds[getSelectedText("default_class")]),ruleTable=document.getElementById("qos_rule_table_container").firstChild,ruleData=getTableDataArray(ruleTable,!0,!0);for(ruleIndex=0;ruleIndex<ruleData.length;ruleIndex++){rulePriority=(ruleIndex+1)*100,ruleId=direction+"_rule_"+rulePriority,ruleTable.firstChild.childNodes[ruleIndex+1].childNodes[0].style.color=="red"?classId=classIds[getSelectedText("default_class")]:classId=classIds[ruleData[ruleIndex][1]],uci.set("qos_gargoyle",ruleId,"",directionRule),uci.set("qos_gargoyle",ruleId,"class",classId),uci.set("qos_gargoyle",ruleId,"test_order",rulePriority),optionList=["source","srcport","destination","dstport","max_pkt_size","min_pkt_size","proto","connbytes_kb"],matchCriteria=parseRuleMatchCriteria(ruleData[ruleIndex][0]);for(criteriaIndex=0;criteriaIndex<optionList.length;criteriaIndex++)matchCriteria[criteriaIndex]!=""&&(value=matchCriteria[criteriaIndex],value=optionList[criteriaIndex]=="proto"?value.toLowerCase():value,uci.set("qos_gargoyle",ruleId,optionList[criteriaIndex],value));matchCriteria[matchCriteria.length-1]!=""&&(protocolMap.getL7ID=function(e){for(key in this)if(this[key]==e)return key},appProtocol=matchCriteria[matchCriteria.length-1],appProtocolName=protocolMap.getL7ID(appProtocol),appProtocolName!=null&&uci.set("qos_gargoyle",ruleId,"layer7",appProtocolName))}f&&qosQuotasExist()?(e="\n/etc/init.d/qos_gargoyle enable ;\n",e=preCommands.join("\n")+"\n"+uci.getScriptCommands(uciOriginal)+"\n"+e+"sh /usr/lib/gargoyle/restart_firewall.sh ;\n"):(e="\n/etc/init.d/qos_gargoyle start ;\n/etc/init.d/qos_gargoyle enable ;\n",e=preCommands.join("\n")+"\n"+uci.getScriptCommands(uciOriginal)+"\n"+n+e+i+r)}if(t!="")alert(t);else if(e.length>0){timerid!=null&&(clearInterval(timerid),timerid=null),setControlsEnabled(!1,!0);var l=function(e){e.readyState==4&&(uciOriginal=uci.clone(),resetData(),setControlsEnabled(!0))},c=getParameterDefinition("commands",e)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,""));runAjax("POST","utility/run_commands.sh",c,l)}}function classinfo(){this.Name=null,this.Percent=null,this.MinBW=null,this.MaxBW=null,this.MinRTT=null,this.bytes=null,this.leaf=null,this.bps=NaN}function init_classtable(){classTable=new Array;var e=new Array,t=direction+"_class",n=uciOriginal.getAllSectionsOfType("qos_gargoyle",t),r=0,i="";removeAllOptionsFromSelectElement(document.getElementById("default_class")),removeAllOptionsFromSelectElement(document.getElementById("classification"));var s=0;for(s=0;s<n.length;s++)r+=parseInt(uciOriginal.get("qos_gargoyle",n[s],"percent_bandwidth"));for(s=0;s<n.length;s++){var o=n[s],u=new classinfo;u.Name=uciOriginal.get("qos_gargoyle",o,"name"),u.Percent=uciOriginal.get("qos_gargoyle",o,"percent_bandwidth"),u.MaxBW=uciOriginal.get("qos_gargoyle",o,"max_bandwidth"),u.MinBW=uciOriginal.get("qos_gargoyle",o,"min_bandwidth"),u.MinRTT=uciOriginal.get("qos_gargoyle",o,"minRTT"),u.Name=u.Name==""?o:u.Name,u.Percent=Math.round(parseInt(u.Percent)*100/r),u.MinBW=u.MinBW!=""&&u.MinBW>0?u.MinBW:"zero",u.MaxBW=u.MaxBW!=""&&u.MaxBW>0?u.MaxBW:"nolimit",u.MinRTT=u.MinRTT=="Yes"?u.MinRTT:"",classTable.push(u),e.push([u.Name,u.Percent+"%",u.MinBW,u.MaxBW,u.MinRTT,bpsToKbpsString(u.bps),createClassTableEditButton(s)]),addOptionToSelectElement("default_class",u.Name,u.Name,null),addOptionToSelectElement("classification",u.Name,u.Name,null),i=uciOriginal.get("qos_gargoyle",direction,"default_class")==o?u.Name:i}var a="";direction=="download"&&(a="Min RTT");var f=["Service Class Name","Percent BW","Min BW (kbps)","Max BW (kbps)",a,"Load (kbps)"],l=createTable(f,e,"qos_class_table",!0,!1,removeServiceClassCallback),c=document.getElementById("qos_class_table_container");c.firstChild!=null&&c.removeChild(c.firstChild),c.appendChild(l),setSelectedText("default_class",i)}function bpsToKbpsString(e){var t="*",n=parseInt(e)/1e3;isNaN(n)?t="*":n<1?t=n.toFixed(1)+"":t=n.toFixed(0)+"";while(t.length<4)t=" "+t;return t}function update_classtable(){var e=document.getElementById("qos_class_table_container").firstChild;if(e==null)return;if(e!=null){var t=getTableDataArray(e,!0,!1);t.length!=classTable.length&&(dynamic_update=!1)}var n=e.firstChild,r;for(r=1;r<=classTable.length;r++){var i=n.childNodes[r];for(classIndex=0;classIndex<classTable.length;classIndex++){var s=classTable[classIndex],o=[s.Name,s.Percent+"%",s.MinBW,s.MaxBW,s.MinRTT,bpsToKbpsString(s.bps)];if(s.Name==i.childNodes[0].firstChild.data){var u=0;for(u=0;u<o.length;u++)i.childNodes[u].firstChild.data=o[u];break}}}}function resetData(){initializeDescriptionVisibility(uciOriginal,"qos_"+(direction=="upload"?"up":"down")+"_1"),initializeDescriptionVisibility(uciOriginal,"qos_"+(direction=="upload"?"up":"down")+"_2"),direction=="download"&&(initializeDescriptionVisibility(uciOriginal,"qos_down_3"),initializeDescriptionVisibility(uciOriginal,"qos_down_4")),uciOriginal.removeSection("gargoyle","help"),totalBandwidth=uciOriginal.get("qos_gargoyle",direction,"total_bandwidth"),totalBandwidth=totalBandwidth==""?-1:totalBandwidth,document.getElementById("qos_enabled").checked=qosEnabled&&totalBandwidth>0,defaultBandwidth=direction=="upload"?320:3200,document.getElementById("total_bandwidth").value=totalBandwidth>0?totalBandwidth:defaultBandwidth,directionRule=direction+"_rule",init_classtable(),update_classtable();var e=uciOriginal.getAllSectionsOfType("qos_gargoyle",directionRule);ruleTableColumns=["Match Criteria","Classification",""],ruleTableData=new Array,rulePriorities=[];for(ruleIndex=0;ruleIndex<e.length;ruleIndex++){ruleSection=e[ruleIndex],rulePriority=uciOriginal.get("qos_gargoyle",ruleSection,"test_order"),rulePriority=rulePriority==""?9999999:rulePriority,rulePriorities.push(rulePriority+","+ruleIndex),optionList=["source","srcport","destination","dstport","max_pkt_size","min_pkt_size","proto","connbytes_kb"],displayOptionList=["Source: $","Source Port: $","Destination: $","Destination Port: $","Maximum Packet Length: $ bytes","Minimum Packet Length: $ bytes","Transport Protocol: $","Connection bytes: $ kBytes"],ruleText="";for(optionIndex=0;optionIndex<optionList.length;optionIndex++)optionValue=uciOriginal.get("qos_gargoyle",ruleSection,optionList[optionIndex]),optionList[optionIndex]=="proto"&&(optionValue=="both"?optionValue="":optionValue=optionValue.toUpperCase()),optionValue!=""&&(substitution=displayOptionList[optionIndex],substitution=substitution.replace(/\$/,optionValue),ruleText=ruleText==""?ruleText+substitution:ruleText+", "+substitution);uciOriginal.get("qos_gargoyle",ruleSection,"layer7")!=""&&(app_protocol="Application Protocol: "+protocolMap[uciOriginal.get("qos_gargoyle",ruleSection,"layer7")],ruleText=ruleText==""?ruleText+app_protocol:ruleText+", "+app_protocol),classification=uciOriginal.get("qos_gargoyle",ruleSection,"class"),idx=parseInt(classification.match(/class_([0-9]+)/)[1])-1,ruleTableData.push([ruleText,classTable[idx].Name,createRuleTableEditButton()])}sortedRulePriorities=rulePriorities.sort(rulePriorityCompareFunction),sortedRuleTableData=new Array;for(rowIndex=0;rowIndex<sortedRulePriorities.length;rowIndex++)sortedRuleTableData.push(ruleTableData[sortedRulePriorities[rowIndex].split(",")[1]]);ruleTable=createTable(ruleTableColumns,sortedRuleTableData,"qos_rule_table",!0,!0),ruleTableContainer=document.getElementById("qos_rule_table_container"),ruleTableContainer.firstChild!=null&&ruleTableContainer.removeChild(ruleTableContainer.firstChild),ruleTableContainer.appendChild(ruleTable),direction=="download"&&(monenabled=uciOriginal.get("qos_gargoyle",direction,"qos_monenabled"),monenabled=="true"&&(document.getElementById("qos_monenabled").checked=!0),ptarget_ip=uciOriginal.get("qos_gargoyle",direction,"ptarget_ip"),ptarget_ip==""?(document.getElementById("use_ptarget_ip").checked=!1,setElementEnabled(document.getElementById("ptarget_ip"),!1,currentWanGateway)):(document.getElementById("use_ptarget_ip").checked=!0,document.getElementById("ptarget_ip").value=ptarget_ip,setElementEnabled(document.getElementById("ptarget_ip"),!0,"")),pinglimit=uciOriginal.get("qos_gargoyle",direction,"pinglimit"),pinglimit==""?(document.getElementById("use_auto_pinglimit").checked=!1,setElementEnabled(document.getElementById("pinglimit"),!1,"Auto")):(document.getElementById("use_auto_pinglimit").checked=!0,document.getElementById("pinglimit").value=pinglimit,setElementEnabled(document.getElementById("pinglimit"),!0,""))),setQosEnabled(),updateInProgress=!1,dynamic_update=!0,updatetc(),direction=="download"&&(uciOriginal.get("qos_gargoyle",direction,"qos_monenabled")=="true"?timerid=setInterval("updateqosmon()",1e3):setTimeout("updateqosmon()",100)),timerid==null&&(timerid=setInterval("updatetc()",2500))}function qosQuotasExist(){var e=uciOriginal.getAllSectionsOfType("firewall","quota"),t,n=!1;for(t=0;t<e.length&&!n;t++){var r=["exceeded_up_speed","exceeded_down_speed","exceeded_up_class_mark","exceeded_down_class_mark"];while(r.length>0&&!n)n=n||uciOriginal.get("firewall",e[t],r.shift())!=""}return n}function setQosEnabled(){enabled=document.getElementById("qos_enabled").checked,controlIds=["default_class","source_ip","source_port","dest_ip","dest_port","max_pktsize","min_pktsize","transport_protocol","connbytes_kb","app_protocol","use_source_ip","use_source_port","use_dest_ip","use_dest_port","use_max_pktsize","use_min_pktsize","use_transport_protocol","use_connbytes_kb","use_app_protocol","classification","add_rule_button","class_name","percent_bandwidth","min_radio1","min_radio2","min_bandwidth","max_radio1","max_radio2","max_bandwidth","add_class_button"],setElementEnabled(document.getElementById("total_bandwidth"),enabled,uciOriginal.get("qos_gargoyle",direction,"total_bandwidth"));for(controlIndex=0;controlIndex<controlIds.length;controlIndex++)setElementEnabled(document.getElementById(controlIds[controlIndex]),enabled,"");setRowClasses(document.getElementById("qos_rule_table_container").firstChild,enabled),setRowClasses(document.getElementById("qos_class_table_container").firstChild,enabled),enabled&&document.getElementById("total_bandwidth").value==""&&(defaultBandwidth=direction=="upload"?320:3200,document.getElementById("total_bandwidth").value=totalBandwidth>0?totalBandwidth:defaultBandwidth),direction=="download"&&(setElementEnabled(document.getElementById("qos_monenabled"),enabled,""),setElementEnabled(document.getElementById("rtt_radio1"),enabled,""),setElementEnabled(document.getElementById("rtt_radio2"),enabled,""),qmenabled=enabled&&document.getElementById("qos_monenabled").checked,setElementEnabled(document.getElementById("use_ptarget_ip"),qmenabled,""),setElementEnabled(document.getElementById("ptarget_ip"),qmenabled&&document.getElementById("use_ptarget_ip").checked,document.getElementById("ptarget_ip").value),setElementEnabled(document.getElementById("use_auto_pinglimit"),qmenabled,""),setElementEnabled(document.getElementById("pinglimit"),qmenabled&&document.getElementById("use_auto_pinglimit").checked,document.getElementById("pinglimit").value)),resetRuleControls(),resetServiceClassControls(document)}function addClassificationRule(){errors=proofreadClassificationRule(document);if(errors.length>0)alert(errors.join("\n")+"\n\nCould not add classification rule.");else{addRuleMatchControls=["source_ip","source_port","dest_ip","dest_port","max_pktsize","min_pktsize","transport_protocol","connbytes_kb","app_protocol"],displayList=["Source: $","Source Port: $","Destination: $","Destination Port: $","Maximum Packet Length: $ bytes","Minimum Packet Length: $ bytes","Transport Protocol: $","Connection bytes: $ kBytes","Application Protocol: $"],ruleText="";for(controlIndex=0;controlIndex<addRuleMatchControls.length;controlIndex++)control=document.getElementById(addRuleMatchControls[controlIndex]),controlValue="",control.type=="text"&&(controlValue=control.value),control.type=="select-one"&&(controlValue=control.options[control.selectedIndex].text),control.disabled==0&&(substitution=displayList[controlIndex],substitution=substitution.replace(/\$/,controlValue),ruleText=ruleText==""?ruleText+substitution:ruleText+", "+substitution);classification=document.getElementById("classification").options[document.getElementById("classification").selectedIndex].text,ruleTable=document.getElementById("qos_rule_table_container").firstChild,addTableRow(ruleTable,[ruleText,classification,createRuleTableEditButton()],!0,!0),resetRuleControls()}}function proofreadClassificationRule(e){addRuleIds=["source_ip","source_port","dest_ip","dest_port","max_pktsize","min_pktsize","transport_protocol","connbytes_kb","app_protocol"],validatePktSize=function(e){return validateNumericRange(e,1,1500)},validateCBSize=function(e){return validateNumericRange(e,0,4194393)},alwaysValid=function(e){return 0},ruleValidationFunctions=[validateIpRange,validatePortOrPortRange,validateIpRange,validatePortOrPortRange,validatePktSize,validatePktSize,alwaysValid,validateCBSize,alwaysValid],labelIds=new Array,returnCodes=new Array,toggledMatchCriteria=0;for(ruleIndex=0;ruleIndex<addRuleIds.length;ruleIndex++)toggledMatchCriteria+=e.getElementById(addRuleIds[ruleIndex]).disabled==1?0:1,labelIds.push(addRuleIds[ruleIndex]+"_label"),returnCodes.push(0);return errors=[],toggledMatchCriteria==0?errors.push("No match criteria have been selected."):errors=proofreadFields(addRuleIds,labelIds,ruleValidationFunctions,returnCodes,addRuleIds,e),errors}function resetRuleControls(){ruleControlIds=["source_ip","source_port","dest_ip","dest_port","max_pktsize","min_pktsize","transport_protocol","connbytes_kb","app_protocol"],document.getElementById("classification").selectedIndex=document.getElementById("default_class").selectedIndex;for(ruleControlIndex=0;ruleControlIndex<ruleControlIds.length;ruleControlIndex++)checkbox=document.getElementById("use_"+ruleControlIds[ruleControlIndex]),checkbox.checked=!1,enableAssociatedField(checkbox,ruleControlIds[ruleControlIndex],"")}function addServiceClass(){errors=proofreadServiceClass(document);if(errors.length>0)alert(errors.join("\n")+"\n\nCould not add new service class.");else{dynamic_update=!1,classRow=new classinfo,classRow.Name=document.getElementById("class_name").value,classRow.Percent=document.getElementById("percent_bandwidth").value+"%",classRow.MaxBW=document.getElementById("min_radio1").checked==1?"zero":document.getElementById("min_bandwidth").value,classRow.MinBW=document.getElementById("max_radio1").checked==1?"nolimit":document.getElementById("max_bandwidth").value,direction=="download"?classRow.MinRTT=document.getElementById("rtt_radio1").checked==1?"Yes":"":classRow.MinRTT="",classTable.push(classRow),newRowData=new Array,newRowData.push(classRow.Name),newRowData.push(classRow.Percent),newRowData.push(classRow.MaxBW),newRowData.push(classRow.MinBW),newRowData.push(classRow.MinRTT),newRowData.push("*"),newRowData.push(createClassTableEditButton(classTable.length-1)),addOptionToSelectElement("default_class",document.getElementById("class_name").value,document.getElementById("class_name").value,null),addOptionToSelectElement("classification",document.getElementById("class_name").value,document.getElementById("class_name").value,null);var e=document.getElementById("qos_class_table_container").firstChild;addTableRow(e,newRowData,!0,!1,removeServiceClassCallback),resetServiceClassControls(document)}}function proofreadServiceClass(e){addClassIds=["class_name","percent_bandwidth","max_bandwidth"],labelIds=["class_name_label","percent_bandwidth_label","max_bandwidth_label"],classValidationFunctions=[function(e){return validateLengthRange(e,1,10)},function(e){return validateNumericRange(e,1,100)},validateNumeric],returnCodes=[0,0,0],errors=proofreadFields(addClassIds,labelIds,classValidationFunctions,returnCodes,addClassIds,e);if(errors.length==""){classTableData=getTableDataArray(document.getElementById("qos_class_table_container").firstChild,!0,!1),classNameMatches=!1,newClassName=e.getElementById("class_name").value;for(rowIndex=0;rowIndex<classTableData.length&&!classNameMatches;rowIndex++)existingClassName=classTableData[rowIndex][0],existingClassName==newClassName&&(classNameMatches=!0,errors.push("Duplicate class name."))}return errors}function resetServiceClassControls(e){e.getElementById("class_name").value="",e.getElementById("percent_bandwidth").value="",e.getElementById("min_radio1").checked=!0,e.getElementById("min_radio2").checked=!1,enableAssociatedField(e.getElementById("min_radio2"),"min_bandwidth","",e),e.getElementById("max_radio1").checked=!0,e.getElementById("max_radio2").checked=!1,enableAssociatedField(e.getElementById("max_radio2"),"max_bandwidth","",e),direction=="download"&&(e.getElementById("rtt_radio1").checked=!1,e.getElementById("rtt_radio2").checked=!0)}function rulePriorityCompareFunction(e,t){return splitA=e.split(","),splitB=t.split(","),splitA[0]-splitB[0]}function removeServiceClassCallback(e,t){if(e.firstChild.childNodes.length==1)e.firstChild.appendChild(t),alert("At least one service class is required.\nCannot remove service class.");else{dynamic_update=!1,removedClassName=t.childNodes[0].firstChild.data,removeOptionFromSelectElement("default_class",removedClassName),removeOptionFromSelectElement("classification",removedClassName),ruleTable=document.getElementById("qos_rule_table_container").firstChild,ruleTableData=getTableDataArray(ruleTable,!0,!0);for(ruleIndex=0;ruleIndex<ruleTableData.length;ruleIndex++)ruleTableData[ruleIndex][1]==removedClassName&&(ruleTable.firstChild.childNodes[ruleIndex+1].childNodes[0].style.color="red",ruleTable.firstChild.childNodes[ruleIndex+1].childNodes[1].style.color="red")}}function createRuleTableEditButton(){return editRuleButton=createInput("button"),editRuleButton.value="Edit",editRuleButton.className="default_button",editRuleButton.onclick=editRuleTableRow,editRuleButton}function editRuleTableRow(){if(typeof editRuleWindow!="undefined")try{editRuleWindow.close()}catch(e){}try{xCoor=window.screenX+225,yCoor=window.screenY+225}catch(e){xCoor=window.left+225,yCoor=window.top+225}editRuleWindow=window.open("qos_edit_rule.sh","test","width=560,height=450,left="+xCoor+",top="+yCoor);try{saveButton=editRuleWindow.document.createElement("input"),saveButton.type="button",closeButton=editRuleWindow.document.createElement("input"),closeButton.type="button"}catch(e){saveButton=editRuleWindow.createElement('<input type="button" />'),closeButton=editRuleWindow.createElement('<input type="button" />')}saveButton.value="Close and Apply Changes",saveButton.className="default_button",closeButton.value="Close and Discard Changes",closeButton.className="default_button",editRuleWindowRow=this.parentNode.parentNode,runOnRuleEditorLoaded=function(){update_done=!1;if(editRuleWindow.document!=null&&editRuleWindow.document.getElementById("bottom_button_container")!=null){editRuleWindow.document.getElementById("bottom_button_container").appendChild(saveButton),editRuleWindow.document.getElementById("bottom_button_container").appendChild(closeButton),serviceClassOptions=document.getElementById("default_class").options;for(classIndex=0;classIndex<serviceClassOptions.length;classIndex++)addOptionToSelectElement("classification",serviceClassOptions[classIndex].text,serviceClassOptions[classIndex].text,null,editRuleWindow.document);ruleControlIds=["source_ip","source_port","dest_ip","dest_port","max_pktsize","min_pktsize","transport_protocol","connbytes_kb","app_protocol"],criteria=parseRuleMatchCriteria(editRuleWindowRow.firstChild.firstChild.data);for(ruleControlIndex=0;ruleControlIndex<ruleControlIds.length;ruleControlIndex++)ruleControlId=ruleControlIds[ruleControlIndex],ruleControl=editRuleWindow.document.getElementById(ruleControlId),ruleControlCheckbox=editRuleWindow.document.getElementById("use_"+ruleControlId),criteria[ruleControlIndex]!=""?(ruleControl.type=="text"&&(ruleControl.value=criteria[ruleControlIndex]),ruleControl.type=="select-one"&&setSelectedText(ruleControlId,criteria[ruleControlIndex],editRuleWindow.document),ruleControlCheckbox.checked=!0):ruleControlCheckbox.checked=!1,enableAssociatedField(ruleControlCheckbox,ruleControlId,"",editRuleWindow.document);setSelectedText("classification",editRuleWindowRow.childNodes[1].firstChild.data,editRuleWindow.document),closeButton.onclick=function(){editRuleWindow.close()},saveButton.onclick=function(){errors=proofreadClassificationRule(editRuleWindow.document);if(errors.length>0)alert(errors.join("\n")+"\n\nCould not update classification rule."),editRuleWindow.focus();else{addRuleMatchControls=["source_ip","source_port","dest_ip","dest_port","max_pktsize","min_pktsize","transport_protocol","connbytes_kb","app_protocol"],displayList=["Source: $","Source Port: $","Destination: $","Destination Port: $","Maximum Packet Length: $ bytes","Minimum Packet Length: $ bytes","Transport Protocol: $","Connection bytes: $ kBytes","Application Protocol: $"],ruleText="";for(controlIndex=0;controlIndex<addRuleMatchControls.length;controlIndex++)control=editRuleWindow.document.getElementById(addRuleMatchControls[controlIndex]),controlValue="",control.type=="text"&&(controlValue=control.value),control.type=="select-one"&&(controlValue=control.options[control.selectedIndex].text),control.disabled==0&&(substitution=displayList[controlIndex],substitution=substitution.replace(/\$/,controlValue),ruleText=ruleText==""?ruleText+substitution:ruleText+", "+substitution);classification=editRuleWindow.document.getElementById("classification").options[editRuleWindow.document.getElementById("classification").selectedIndex].text,editRuleWindowRow.childNodes[0].firstChild.data=ruleText,editRuleWindowRow.childNodes[0].style.color="black",editRuleWindowRow.childNodes[1].firstChild.data=classification,editRuleWindowRow.childNodes[1].style.color="black",editRuleWindow.close()}},editRuleWindow.moveTo(xCoor,yCoor),editRuleWindow.focus(),update_done=!0}update_done==0&&setTimeout("runOnRuleEditorLoaded()",250)},runOnRuleEditorLoaded()}function createClassTableEditButton(e){return editClassButton=createInput("button"),editClassButton.value="Edit",editClassButton.className="default_button",editClassButton.onclick=editClassTableRow,editClassButton.id=""+e,editClassButton}function editClassTableRow(){dynamic_update=!1;if(typeof editClassWindow!="undefined")try{editClassWindow.close()}catch(e){}try{xCoor=window.screenX+225,yCoor=window.screenY+225}catch(e){xCoor=window.left+225,yCoor=window.top+225}editClassWindow=window.open("qos_edit_class.sh","test","width=560,height=375,left="+xCoor+",top="+yCoor);try{saveButton=editClassWindow.document.createElement("input"),saveButton.type="button",closeButton=editClassWindow.document.createElement("input"),closeButton.type="button"}catch(e){saveButton=editClassWindow.createElement('<input type="button" />'),closeButton=editClassWindow.createElement('<input type="button" />')}saveButton.value="Close and Apply Changes",saveButton.className="default_button",closeButton.value="Close and Discard Changes",closeButton.className="default_button",editClassWindowRow=this.parentNode.parentNode,runOnClassEditorLoaded=function(){update_done=!1;if(editClassWindow.document!=null&&editClassWindow.document.getElementById("bottom_button_container")!=null&&updateInProgress==0){updateInProgress=!0,direction=="upload"&&(editClassWindow.document.getElementById("rttdiv").style.display="none");var e=setInterval(function(){editClassWindow.closed&&(clearInterval(e),updateInProgress=!1,dynamic_update=!0)},700);editClassWindow.document.getElementById("bottom_button_container").appendChild(saveButton),editClassWindow.document.getElementById("bottom_button_container").appendChild(closeButton),resetServiceClassControls(editClassWindow.document),cells=editClassWindowRow.childNodes,editClassWindow.document.getElementById("class_name").value=cells[0].firstChild.data,percent=cells[1].firstChild.data,editClassWindow.document.getElementById("percent_bandwidth").value=percent.substr(0,percent.length-1),cells[2].firstChild.data!="zero"&&(editClassWindow.document.getElementById("min_radio2").checked=!0,enableAssociatedField(editClassWindow.document.getElementById("min_radio2"),"min_bandwidth","",editClassWindow.document),minBandwidth=cells[2].firstChild.data,editClassWindow.document.getElementById("min_bandwidth").value=minBandwidth),cells[3].firstChild.data!="nolimit"&&(editClassWindow.document.getElementById("max_radio2").checked=!0,enableAssociatedField(editClassWindow.document.getElementById("max_radio2"),"max_bandwidth","",editClassWindow.document),maxBandwidth=cells[3].firstChild.data,editClassWindow.document.getElementById("max_bandwidth").value=maxBandwidth),cells[4].firstChild.data=="Yes"?editClassWindow.document.getElementById("rtt_radio1").checked=!0:editClassWindow.document.getElementById("rtt_radio2").checked=!0,closeButton.onclick=function(){clearInterval(e),editClassWindow.close()},saveButton.onclick=function(){errors=proofreadServiceClass(editClassWindow.document),errors.length==1&&errors[0]=="Duplicate class name."&&editClassWindow.document.getElementById("class_name").value==editClassWindowRow.childNodes[0].firstChild.data&&(errors=[]);if(errors.length>0)alert(errors.join("\n")+"\n\nCould not update service class."),editClassWindow.focus();else{oldClassName=editClassWindowRow.childNodes[0].firstChild.data,newClassName=editClassWindow.document.getElementById("class_name").value;if(newClassName!=oldClassName){selectIds=["default_class","classification"];for(selectIndex=0;selectIndex<selectIds.length;selectIndex++){selectElement=document.getElementById(selectIds[selectIndex]);for(optionIndex=0;optionIndex<selectElement.options.length;optionIndex++)selectElement.options[optionIndex].text==oldClassName&&(selectElement.options[optionIndex].text=newClassName)}ruleTable=document.getElementById("qos_rule_table_container").firstChild,ruleTableData=getTableDataArray(ruleTable,!0,!0);for(ruleIndex=0;ruleIndex<ruleTableData.length;ruleIndex++)ruleTableData[ruleIndex][1]==oldClassName&&(ruleTable.firstChild.childNodes[ruleIndex+1].childNodes[1].firstChild.data=newClassName),ruleTableData[ruleIndex][1]==newClassName&&(ruleTable.firstChild.childNodes[ruleIndex+1].childNodes[0].style.color="black",ruleTable.firstChild.childNodes[ruleIndex+1].childNodes[1].style.color="black")}var t=classTable[editClassWindowRow.childNodes[6].firstChild.id];t.Name=editClassWindow.document.getElementById("class_name").value,t.Percent=editClassWindow.document.getElementById("percent_bandwidth").value,t.MinBW=editClassWindow.document.getElementById("min_radio1").checked==1?"zero":editClassWindow.document.getElementById("min_bandwidth").value,t.MaxBW=editClassWindow.document.getElementById("max_radio1").checked==1?"nolimit":editClassWindow.document.getElementById("max_bandwidth").value,t.MinRTT=editClassWindow.document.getElementById("rtt_radio1").checked==1?"Yes":"",editClassWindowRow.childNodes[0].firstChild.data=t.Name,editClassWindowRow.childNodes[1].firstChild.data=t.Percent+"%",editClassWindowRow.childNodes[2].firstChild.data=t.MinBW,editClassWindowRow.childNodes[3].firstChild.data=t.MaxBW,editClassWindowRow.childNodes[4].firstChild.data=t.MinRTT,updateInProgress=!1,clearInterval(e),editClassWindow.close()}},editClassWindow.moveTo(xCoor,yCoor),editClassWindow.focus(),update_done=!0}update_done==0&&setTimeout("runOnClassEditorLoaded()",250)},runOnClassEditorLoaded()}function parseRuleMatchCriteria(e){splitText=e.split(/[\t ]*,[\t ]*/),criteria=[],possibleCriteria=["Source: (.*)","Source Port: (.*)","Destination: (.*)","Destination Port: (.*)","Maximum Packet Length: (.*) bytes","Minimum Packet Length: (.*) bytes","Transport Protocol: (.*)","Connection bytes: (.*) kBytes","Application Protocol: (.*)"];for(possibleCriteriaIndex=0;possibleCriteriaIndex<possibleCriteria.length;possibleCriteriaIndex++){criterionRegExp=new RegExp(possibleCriteria[possibleCriteriaIndex]),found=!1;for(splitIndex=0;splitIndex<splitText.length&&!found;splitIndex++)test=splitText[splitIndex].match(criterionRegExp),test!=null&&(found=!0,criteria.push(test[1]));found||criteria.push("")}return criteria}function updatetc(){if(!updateInProgress&&dynamic_update==1){updateInProgress=!0;var e="tc -s class show dev ";direction=="download"?e+="imq0":e+=currentWanName;var t=getParameterDefinition("commands",e)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),n=function(e){if(e.readyState==4){var t=e.responseText.match(/hfsc\s1:[0-9]{1,2}\s.+leaf.+\n.+Sent\s[0-9]+/g),n=new Date,r=n.getTime()-lasttime;lasttime=n.getTime
();if(t!=null)for(i=0;i<t.length;i++){var s=parseInt(t[i].match(/hfsc\s1:([0-9]+)/)[1])-2,o;s<classTable.length&&(o=classTable[s].bytes,classTable[s].bytes=t[i].match(/Sent\s([0-9]+)/)[1],classTable[s].leaf=t[i].match(/leaf\s([0-9a-f]*)/)[1],o!=null?classTable[s].bps=(parseInt(classTable[s].bytes)-parseInt(o))*8e3/r:classTable[s].bps=NaN)}update_classtable(),updateInProgress=!1}};runAjax("POST","utility/run_commands.sh",t,n)}}function updateqosmon(){if(!updateInProgress){updateInProgress=!0;var e="cat /tmp/qosmon.status",t=getParameterDefinition("commands",e)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),n=function(e){if(e.readyState==4){var t=e.responseText.split("\n");if(t[0].substr(0,6)=="State:"){document.getElementById("qstate").innerHTML=t[0],document.getElementById("qllimit").innerHTML=t[1],document.getElementById("qollimit").innerHTML=t[2],document.getElementById("qload").innerHTML=t[3],document.getElementById("qpinger").innerHTML=t[4],document.getElementById("qpingtime").innerHTML=t[5],document.getElementById("qpinglimit").innerHTML=t[6],document.getElementById("qactivecnt").innerHTML=t[7],t=e.responseText.match(/ID\s+[0-9A-F]+.*/g);for(i=0;i<t.length;i++){var n=t[i].match(/ID\s+([0-9A-F]+)/)[1],r;for(r=0;r<classTable.length;r++)if(classTable[r].leaf!=null&&classTable[r].leaf.toUpperCase()==n)break;r<classTable.length&&(classTable[r].bps=parseInt(t[i].match(/ID\s+[0-9A-F]+.*:\s([0-9]+)/)[1]))}dynamic_update==1&&update_classtable()}else t[0].substr(0,25)=="cat: can't open '/tmp/qos"&&(document.getElementById("qstate").innerHTML="State: Disabled*",document.getElementById("qpinger").innerHTML="Ping: Off");updateInProgress=!1}};runAjax("POST","utility/run_commands.sh",t,n)}}var classTable,dynamic_update=!0,timerid=null,updateInProgress=!1,lasttime;