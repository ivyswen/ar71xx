/*
 * This program is copyright ï¿½ 2008 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function saveChanges(){errorList=proofreadAll();if(errorList.length>0)errorString=errorList.join("\n")+"\n\nChanges could not be applied.",alert(errorString);else{setControlsEnabled(!1,!0),uci=uciOriginal.clone();var e=[];for(sectionIndex=0;sectionIndex<3;sectionIndex++){var t=document.getElementById("server"+(sectionIndex+1)).value;t!=""&&e.push(t)}uci.createListOption("system","ntp","server",!0),uci.set("system","ntp","server",e,!1);var n=uciOriginal.getAllSectionsOfType("system","system"),r=uciOriginal.getAllOptionsInSection("system",n[0]),i=getSelectedValue("date_format");uci.set("gargoyle","global","dateformat",getSelectedValue("date_format"));var s=[];s.iso='"+%Y/%m/%d %H:%M %Z"',s.iso8601='"+%Y-%m-%d %H:%M %Z"',s.australia='"+%d/%m/%y %H:%M %Z"',s.usa='"+%m/%d/%y %H:%M %Z"',s.russia='"+%d.%m.%Y %H:%M %Z"',s.argentina='"+%d/%m/%Y %H:%M %Z"';var o="";getSelectedValue("timezone").match(/UTC/)?o="date "+s[i]+" | sed 's/UTC/UTC-"+getSelectedValue("timezone").replace(/UTC/,"")+"/g' | sed 's/\\-\\-/+/g'":o="date "+s[i];var u=[];uci.set("system",n[0],"timezone",getSelectedValue("timezone")),n[0]!="system"&&(u.push("uci del system."+n[0]),u.push("uci commit"),u.push("uci set system.system=system"),u.push("uci commit")),uci.set("system","system","","system");var a=0;for(a=0;a<r.length;a++)uci.set("system","system",r[a],uci.get("system",n[0],r[a]));n[0]!="system"&&(uciOriginal.removeSection("system",n[0]),uci.removeSection("system",n[0]));var f="uci show system | grep timezone | sed 's/^.*=//g' >/etc/TZ\n";commands=u.join("\n")+"\n"+uci.getScriptCommands(uciOriginal)+"\n"+f+"\n"+"/etc/init.d/sysntpd restart\n/usr/bin/set_kernel_timezone\n"+o;var l=getParameterDefinition("commands",commands)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),c=function(e){if(e.readyState==4){var t=e.responseText.split(/[\r\n]+/);if(t!=null){while(t.length>0&&!t[t.length-1].match(/:/))t.pop();t.length>0&&(currentTime=t[t.length-1])}uciOriginal=uci.clone(),resetData(),setControlsEnabled(!0)}};runAjax("POST","utility/run_commands.sh",l,c)}}function proofreadAll(){return""}function resetData(){setChildText("current_time",currentTime),timezoneList=timezoneData[0],timezoneDefinitions=timezoneData[2],removeAllOptionsFromSelectElement(document.getElementById("timezone"));for(tzIndex=0;tzIndex<timezoneList.length;tzIndex++)timezone=timezoneList[tzIndex],addOptionToSelectElement("timezone",timezone,timezoneDefinitions[timezone]);var e=uciOriginal.getAllSectionsOfType("system","system"),t=uciOriginal.get("system",e[0],"timezone");t=t=="UTC"?"UTC0":t,setSelectedValue("timezone",previousTimezoneDefinition),setSelectedValue("timezone",t),previousTimezoneDefinition=t;var n=uciOriginal.get("gargoyle","global","dateformat");setSelectedValue("date_format","usa"),setSelectedValue("date_format",n);var r=uciOriginal.get("system","ntp","server"),r=r==null||r==""?[]:r;while(r.length>3)r.pop();var i;for(i=0;i<r.length;i++)document.getElementById("server"+(1+i)).value=r[i];currentRegion="custom";if(r.length>=3){testRegion="",validRegion=!0;for(serverIndex=0;serverIndex<3&&validRegion;serverIndex++)validRegion=!1,nextRegion=r[serverIndex].match(/[0-9]+\.([^\.]+)\.pool\.ntp\.org/),nextRegion==null&&r[serverIndex].match(/[0-9]+\.pool\.ntp\.org/)&&(nextRegion=["","global"]),nextRegion!=null&&(nextRegion[1]==testRegion||testRegion=="")&&(testRegion=nextRegion[1],validRegion=!0);currentRegion=validRegion?testRegion:currentRegion}else for(serverIndex=r.length;serverIndex<3;serverIndex++)document.getElementById("server"+(1+i)).value=2-serverIndex+".pool.ntp.org";setSelectedValue("region","custom"),setSelectedValue("region",currentRegion),updateServerList()}function timezoneChanged(){timezoneRegions=timezoneData[1],definitionTimezones=timezoneData[3],newTimezoneDefinition=getSelectedValue("timezone"),getSelectedValue("region")==timezoneRegions[definitionTimezones[previousTimezoneDefinition]]&&(setSelectedValue("region",timezoneRegions[definitionTimezones[newTimezoneDefinition]]),updateServerList()),previousTimezoneDefinition=newTimezoneDefinition}function updateServerList(){var e=getSelectedValue("region");for(serverIndex=1;serverIndex<=3;serverIndex++)if(e=="custom")setElementEnabled(document.getElementById("server"+serverIndex),!0,document.getElementById("server"+serverIndex).value);else{var t=(3-serverIndex+"."+e+".pool.ntp.org").replace(/\.global\./,".");setElementEnabled(document.getElementById("server"+serverIndex),!1,t)}}var previousTimezoneDefinition="PST8PDT,M3.2.0/2,M11.1.0/2";