/*
 * This program is copyright ï¿½ 2008 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function saveChanges(){setControlsEnabled(!1,!0),deleteCommands=[],sections=uciOriginal.getAllSections("ddns_gargoyle");for(sectionIndex=0;sectionIndex<sections.length;sectionIndex++)deleteCommands.push("uci del ddns_gargoyle."+sections[sectionIndex]);deleteCommands.push("uci commit"),createCommands=uci.getScriptCommands(new UCIContainer),testCommands=["/etc/init.d/ddns_gargoyle stop","/etc/init.d/ddns_gargoyle test_config"],commands=deleteCommands.join("\n")+"\n"+createCommands+"\n"+testCommands.join("\n");var e=getParameterDefinition("commands",commands)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),t=function(e){e.readyState==4&&saveChangesPart2(e.responseText)};runAjax("POST","utility/run_commands.sh",e,t)}function saveChangesPart2(e){resettingAfterFailedUpdate=!1,responseLines=e.split(/[\r\n]+/),names=responseLines[0].split(/[\t ]+/),success=responseLines[1].split(/[\t ]+/),newFailedDomains=[],deleteCommands=[];for(nameIndex=0;nameIndex<names.length&&names.length==success.length;nameIndex++)if(success[nameIndex]=="0"){found=!1,failedName=names[nameIndex];for(newIndex=0;newIndex<newSections.length&&!found;newIndex++)failedName==newSections[newIndex]&&(resettingAfterFailedUpdate=!0,setDocumentFromUci(uci,"ddns_gargoyle",failedName,document),found=!0,failedDomain=uci.get("ddns_gargoyle",failedName,"domain"),failedDomain=failedDomain==""?uci.get("ddns_gargoyle",failedName,"service_provider"):failedDomain,newFailedDomains.push(failedDomain),deleteCommands.push("uci del ddns_gargoyle."+failedName),uci.removeSection("ddns_gargoyle",failedName))}deleteCommands.push("uci commit"),newFailedDomains.length>0&&alert("Update of new dynamic DNS service configuration(s) failed:\n"+newFailedDomains.join("\n")+"\n\nService(s) could not be updated properly and have therefore been removed."),getUpdateTimeCommands=[],sections=uci.getAllSections("ddns_gargoyle");for(sectionIndex=0;sectionIndex<sections.length;sectionIndex++)getUpdateTimeCommands.push("echo "+sections[sectionIndex]+" $(cat /var/last_ddns_updates/"+sections[sectionIndex]+")");commands=deleteCommands.join("\n")+"\n"+"/etc/init.d/ddns_gargoyle enable\n"+"/etc/init.d/ddns_gargoyle restart\n"+getUpdateTimeCommands.join("\n");var t=getParameterDefinition("commands",commands)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),n=function(e){if(e.readyState==4){responseLines=e.responseText.split(/[\r\n]+/);for(responseIndex=0;responseIndex<responseLines.length-1;responseIndex++)lineParts=responseLines[responseIndex].split(/[\t ]+/),updateTimes[lineParts[0]]=lineParts[1];uciOriginal=uci.clone(),resetData(),setControlsEnabled(!0)}};runAjax("POST","utility/run_commands.sh",t,n)}function resetData(){initializeDescriptionVisibility(uciOriginal,"ddns_1"),uciOriginal.removeSection("gargoyle","help"),uci=uciOriginal.clone(),newSections=[],updatedSections=[],serviceProviders=parseProviderData();var e=[],t;for(t=0;t<serviceProviders.length;t++)e.push(serviceProviders[t].name);e.sort(function(e,t){return e=e.toLowerCase(),t=t.toLowerCase(),e<t?-1:e>t?1:0}),setAllowableSelections("ddns_provider",e,e,document),resettingAfterFailedUpdate||setDocumentFromUci(new UCIContainer,"","",document),resettingAfterFailedUpdate=!1;var n=uci.getAllSections("ddns_gargoyle"),r=["Domain","Last Update","Enabled","",""],i=new Array,s=new Array;for(sectionIndex=0;sectionIndex<n.length;sectionIndex++){var o=n[sectionIndex],u=uciOriginal.get("ddns_gargoyle",o,"domain");u=u==""?uciOriginal.get("ddns_gargoyle",o,"service_provider"):u,u=u.length>20?u.substr(0,17)+"...":u;var a=new Date;updateTimes[o]!=null&&a.setTime(1e3*updateTimes[o]);var f=uciOriginal.get("gargoyle","global","dateformat"),l=function(e){var t=""+e;return t=t.length==1?"0"+t:t,t},c=l(a.getMonth()+1),h=l(a.getDate()),p=" "+a.getHours()+":"+l(a.getMinutes())+":"+l(a.getSeconds()),d=f==""||f=="usa"?c+"/"+h+p:h+"/"+c+p;d=f=="russia"?h+"."+c+p:d,d=f=="argentina"?h+"/"+c+p:d,d=f=="iso8601"?c+"-"+h+p:d,d=updateTimes[o]==null?"Never":d;var v=createEnabledCheckbox();v.checked=uciOriginal.get("ddns_gargoyle",o,"enabled")=="1"?!0:!1,v.id=o,i.push([u,d,v,createEditButton(),createForceUpdateButton()]),i[i.length-1][4].disabled=v.checked?!1:!0,i[i.length-1][4].className=v.checked?"default_button":"default_button_disabled",s.push(v.checked)}var m=createTable(r,i,"ddns_table",!0,!1,removeServiceProviderCallback),g=document.getElementById("ddns_table_container");g.firstChild!=null&&g.removeChild(g.firstChild),g.appendChild(m);for(deIndex=0;deIndex<s.length;deIndex++)i[deIndex][2].checked=s[deIndex]}function addDdnsService(){var e=proofreadServiceProvider(document);if(e.length>0)errorString=e.join("\n")+"\n\nChanges could not be applied.",alert(errorString);else{var t=uci.getAllSections("ddns_gargoyle"),n=1+t.length;while(uci.get("ddns_gargoyle","ddns_"+n)!="")n++;var r="ddns_"+n,i=getSelectedValue("ddns_provider");setUciFromDocument(uci,"ddns_gargoyle",r,document);var s=uci.get("ddns_gargoyle",r,"domain");s=s==""?i:s,s=s.length>20?s.substr(0,17)+"...":s;var o=createEnabledCheckbox();o.checked=!0,o.id=r;var u=[s,"Never",o,createEditButton(),createForceUpdateButton()],a=document.getElementById("ddns_table_container").firstChild;addTableRow(a,u,!0,!1,removeServiceProviderCallback),setDocumentFromUci(new UCIContainer,"","",document),newSections.push(r),updatedSections.push(r)}}function removeServiceProviderCallback(e,t){var n=t.childNodes[2].firstChild.id;uci.removeSection("ddns_gargoyle",n)}function proofreadServiceProvider(e){var t=["ddns_check","ddns_force"],n=["ddns_check_label","ddns_force_label"],r=[validateNumeric,validateNumeric],i=[0,0],s=function(e){return validateLengthRange(e,1,999)},o;e.getElementById("ddns_provider_text")!=null?o=e.getElementById("ddns_provider_text").firstChild.data:o=getSelectedValue("ddns_provider",e);var u=null;for(providerIndex=0;providerIndex<serviceProviders.length&&u==null;providerIndex++)u=serviceProviders[providerIndex]["name"]==o?serviceProviders[providerIndex]:null;if(u==null){alert("ERROR: specified provider is invalid");return}var a=u.variables,f=u.optional_variables,l=[],c=0;for(c=0;c<u.boolean_variables.length;c++)l[u.boolean_variables[c]]=1;for(c=0;c<a.length;c++)l[a[c]]!=1&&(t.push(a[c]),n.push(a[c]+"_label"),r.push(s),i.push(0));for(c=0;c<f.length;c++)l[f[c]]!=1&&e.getElementById(f[c]+"_enabled").checked&&(t.push(f[c]),n.push(f[c]+"_label"),r.push(s),i.push(0));var h=proofreadFields(t,n,r,i,t,e);for(c=0;c<a.length;c++)l[a[c]]!=1&&(e.getElementById(a[c]).className="");for(c=0;c<f.length;c++)l[f[c]]!=1&&e.getElementById(f[c]+"_enabled").checked&&(e.getElementById(f[c]).className="");if(h.length==0){var p;e.getElementById("domain")!=null?p=e.getElementById("domain").value:p=o;var d=uci.getAllSectionsOfType("ddns_gargoyle","service"),v=!1;for(serviceIndex=0;serviceIndex<d.length&&v==0;serviceIndex++){var m=uci.get("ddns_gargoyle",d[serviceIndex],"domain");m=m==""?uci.get("ddns_gargoyle",d[serviceIndex],"service_provider"):m,v=m==p?!0:!1}v&&h.push("Duplicate update specified.")}return h}function setUciFromDocument(e,t,n,r){r==null&&(r=document);var i;r.getElementById("ddns_provider_text")!=null?i=r.getElementById("ddns_provider_text").firstChild.data:i=getSelectedValue("ddns_provider",r),e.removeSection("ddns_gargoyle",n),e.set("ddns_gargoyle",n,"","service"),e.set("ddns_gargoyle",n,"enabled","1"),e.set("ddns_gargoyle",n,"service_provider",i),e.set("ddns_gargoyle",n,"ip_source","internet"),e.set("ddns_gargoyle",n,"force_interval",r.getElementById("ddns_force").value),e.set("ddns_gargoyle",n,"force_unit","days"),e.set("ddns_gargoyle",n,"check_interval",r.getElementById("ddns_check").value),e.set("ddns_gargoyle",n,"check_unit","minutes");var s=null;for(providerIndex=0;providerIndex<serviceProviders.length&&s==null;providerIndex++)s=serviceProviders[providerIndex]["name"]==i?serviceProviders[providerIndex]:null;if(s==null){alert("ERROR: specified provider is invalid");return}var o=s.variables,u=s.optional_variables,a=[],f=0;for(f=0;f<s.boolean_variables.length;f++)a[s.boolean_variables[f]]=1;for(f=0;f<o.length;f++){var l=r.getElementById(o[f]),c=a[l.id]!=1?l.value:l.checked?"1":"0";c!=""&&e.set("ddns_gargoyle",n,l.id,c)}for(f=0;f<u.length;f++){var l=r.getElementById(u[f]);a[l.id]!=1?r.getElementById(l.id+"_enabled").checked&&e.set("ddns_gargoyle",n,l.id,l.value):e.set("ddns_gargoyle",n,l.id,l.checked?"1":"0")}}function setDocumentFromUci(e,t,n,r){r==null&&(r=document);var i=e.get(t,n,"service_provider");r.getElementById("ddns_provider_text")!=null?r.getElementById("ddns_provider_text").appendChild(r.createTextNode(i)):setSelectedValue("ddns_provider",i,r);var s=setProvider(r),o=s.variables,u=s.optional_variables,a=[],f=0;for(f=0;f<s.boolean_variables.length;f++)a[s.boolean_variables[f]]=1;for(f=0;f<o.length;f++){var l=r.getElementById(o[f]);a[l.id]!=1?l.value=e.get(t,n,l.id):l.checked=e.get(t,n,l.id)=="1"?!0:!1}for(f=0;f<u.length;f++){var l=r.getElementById(u[f]);if(a[l.id]!=1){var c=r.getElementById(u[f]+"_enabled");c.checked=e.get(t,n,l.id)!="",c.checked&&(l.value=e.get(t,n,l.id)),setElementEnabled(l,c.checked,"")}else l.checked=e.get(t,n,l.id)=="1"?!0:!1}var h=getMultipleFromUnit(e.get("ddns_gargoyle",n,"check_unit"))*e.get("ddns_gargoyle",n,"check_interval")/60;h=h>0?h:15,r.getElementById("ddns_check").value=h;var p=getMultipleFromUnit(e.get("ddns_gargoyle",n,"force_unit"))*e.get("ddns_gargoyle",n,"force_interval")/86400;p=p>0?p:3,r.getElementById("ddns_force").value=p}function setProvider(e){e==null&&(e=document);var t;e.getElementById("ddns_provider_text")!=null?t=e.getElementById("ddns_provider_text").firstChild.data:t=getSelectedValue("ddns_provider",e);var n=null;for(providerIndex=0;providerIndex<serviceProviders.length&&n==null;providerIndex++)n=serviceProviders[providerIndex]["name"]==t?serviceProviders[providerIndex]:null;if(n!=null){var r=n.variables,i=n.variable_names,s=new Array,o=[],u=0;for(u=0;u<n.boolean_variables.length;u++)o[n.boolean_variables[u]]=1;for(u=0;u<r.length;u++){var a=e.createElement("div"),f=e.createElement("label");f.className="leftcolumn",f.id=r[u]+"_label",f.appendChild(e.createTextNode(i[u]+":")),a.appendChild(f);var l;o[r[u]]!=1?l=createInput("text",e):l=createInput("checkbox",e),l.className="rightcolumn",l.id=r[u],a.appendChild(l),s.push(a),f.setAttribute("for",l.id)}var c=n.optional_variables,h=n.optional_variable_names;for(u=0;u<c.length;u++){var a=e.createElement("div"),f=e.createElement("label");f.className="leftcolumn",f.id=c[u]+"_label",f.appendChild(e.createTextNode(h[u]+":")),a.appendChild(f);if(o[c[u]]!=1){var p=e.createElement("span");p.className="rightcolumn";var d=createInput("checkbox",e);d.style.position="relative",d.style.top="3px";var v=createInput("text",e);d.id=c[u]+"_enabled",v.id=c[u],d.onclick=function(){var t=this.id.replace("_enabled","");setElementEnabled(e.getElementById(t),this.checked,"")},p.appendChild(d),p.appendChild(v),a.appendChild(p),f.setAttribute("for",d.id)}else{var l=createInput("checkbox",e);l.className="rightcolumn",l.id=c[u],a.appendChild(l),f.setAttribute("for",l.id)}s.push(a)}container=e.getElementById("ddns_variable_container");while(container.childNodes.length>0)container.removeChild(container.firstChild);for(newElementIndex=0;newElementIndex<s.length;newElementIndex++)container.appendChild(s[newElementIndex]);for(u=0;u<c.length;u++)o[c[u]]!=1&&setElementEnabled(e.getElementById(c[u]),e.getElementById(c[u]+"_enabled").checked,"")}return n}function createEnabledCheckbox(){return enabledCheckbox=createInput("checkbox"),enabledCheckbox.onclick=setRowEnabled,enabledCheckbox}function createEditButton(){return editButton=createInput("button"),editButton.value="Edit",editButton.className="default_button",editButton.onclick=editServiceTableRow,editButton}function createForceUpdateButton(){return updateButton=createInput("button"),updateButton.value="Force Update",updateButton.className="default_button",updateButton.onclick=forceUpdateForRow,updateButton}function setRowEnabled(){var e=this.checked?"1":"0",t=this.parentNode.parentNode,n=t.firstChild.firstChild.data;t.childNodes[4].firstChild.disabled=this.checked?!1:!0,t.childNodes[4].firstChild.className=this.checked?"default_button":"default_button_disabled";var r=t.childNodes[2].firstChild.id;uci.set("ddns_gargoyle",r,"enabled",e),updatedSections.push(r)}function parseProviderData(){providers=new Array;for(providerLineIndex=0;providerLineIndex<providerData.length;providerLineIndex++){line=providerData[providerLineIndex];if(line.match(/^[\t ]*service[\t ]+/)){var e=new Array,t=line.split(/ervice[\t ]+/);e.name=t[1],e.optional_variables=[],e.optional_variable_names=[],e.boolean_variables=[],line="",providerLineIndex++;while(providerLineIndex<providerData.length&&line.match(/^[\t ]*service[\t ]+/)==null)line=providerData[providerLineIndex],line.match(/^[\t ]*required_variables[\t ]+/)?(variablePart=line.match(/ariables[\t ]+(.*)$/)[1],e.variables=variablePart.split(/[\t ]+/)):line.match(/^[\t ]*optional_variables[\t ]+/)?(variablePart=line.match(/ariables[\t ]+(.*)$/)[1],e.optional_variables=variablePart.split(/[\t ]+/)):line.match(/^[\t ]*required_variable_names[\t ]+/)?(variablePart=line.match(/ariable_names[\t ]+(.*)$/)[1],e.variable_names=variablePart.split(/,/)):line.match(/^[\t ]*optional_variable_names[\t ]+/)?(variablePart=line.match(/ariable_names[\t ]+(.*)$/)[1],e.optional_variable_names=variablePart.split(/,/)):line.match(/^[\t ]*boolean_variables[\t ]+/)&&(variablePart=line.match(/ariables[\t ]+(.*)$/)[1],e.boolean_variables=variablePart.split(/[\t ]+/)),providerLineIndex++;e["name"]!=null&&e["variables"]!=null&&e["variable_names"]!=null&&providers.push(e),line.match(/^[\t ]*service[\t ]+/)&&(providerLineIndex-=2)}}return providers}function forceUpdateForRow(){var e=this.parentNode.parentNode,t=uci.getAllSections("ddns_gargoyle"),n=e.firstChild.firstChild.data,r=e.childNodes[2].firstChild.id,i=!1;for(updatedIndex=0;updatedIndex<updatedSections.length&&!i;updatedIndex++)i=r==updatedSections[updatedIndex];if(i)alert('This service has been added/modified and therefore you must save your changes before an update can be performed.  Click "Save Changes" and try again.');else{setControlsEnabled(!1,!0);var s="/usr/bin/ddns_gargoyle -P /etc/ddns_providers.conf -C /etc/ddns_gargoyle.conf -m -f "+r;s=s+"\n"+"echo $(cat /var/last_ddns_updates/"+r+") ";var o=getParameterDefinition("commands",s)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),u=function(e){if(e.readyState==4){var t=e.responseText.split(/[\r\n]+/);setControlsEnabled(!0),t[0]=="0"?alert("Update failed.  Ensure your configuration is valid and that you are connected to the internet."):(alert("Update successful."),updateTimes[r]=t[1],resetData())}};runAjax("POST","utility/run_commands.sh",o,u)}}function editServiceTableRow(){if(typeof editServiceWindow!="undefined")try{editServiceWindow.close()}catch(e){}var t,n;try{t=window.screenX+225,n=window.screenY+225}catch(e){t=window.left+225,n=window.top+225}editServiceWindow=window.open("ddns_edit_service.sh","edit","width=560,height=500,left="+t+",top="+n);var r=createInput("button",editServiceWindow.document),i=createInput("button",editServiceWindow.document);r.value="Close and Apply Changes",r.className="default_button",i.value="Close and Discard Changes",i.className="default_button";var s=this.parentNode.parentNode,o=s.childNodes[2].firstChild.id,u=uci.get("ddns_gargoyle",o,"service_provider"),a=uci.get("ddns_gargoyle",o,"domain");a=a==""?u:a;var f=null;for(providerIndex=0;providerIndex<serviceProviders.length&&f==null;providerIndex++)f=u==serviceProviders[providerIndex]["name"]?serviceProviders[providerIndex]:null;var l=f.variables,c=f.variable_names;runOnServiceEditorLoaded=function(){update_done=!1,editServiceWindow.document!=null&&editServiceWindow.document.getElementById("bottom_button_container")!=null&&(editServiceWindow.document.getElementById("bottom_button_container").appendChild(r),editServiceWindow.document.getElementById("bottom_button_container").appendChild(i),setDocumentFromUci(uci,"ddns_gargoyle",o,editServiceWindow.document),i.onclick=function(){editServiceWindow.close()},r.onclick=function(){var e=editServiceWindow.document.getElementById("domain")!=null?editServiceWindow.document.getElementById("domain").value:u,t=proofreadServiceProvider(editServiceWindow.document);t.length==1&&t[0].match(/Duplicate/)&&e==a&&(t=[]);if(t.length>0)alert(t.join("\n")+"\n\nCould not update service class."),editServiceWindow.focus();else{var n=e.length>20?e.substr(0,17)+"...":e;s.firstChild.firstChild.data=n,setUciFromDocument(uci,"ddns_gargoyle",o,editServiceWindow.document),updatedSections.push(o),editServiceWindow.close()}},editServiceWindow.moveTo(t,n),editServiceWindow.focus(),update_done=!0),update_done==0&&setTimeout("runOnServiceEditorLoaded()",250)},runOnServiceEditorLoaded()}function getMultipleFromUnit(e){return multiple=1,e=="minutes"?multiple=60:e=="hours"?multiple=3600:e=="days"?multiple=86400:e=="weeks"?multiple=604800:multiple=1,multiple}var serviceProviders,uci,newSections,updatedSections,resettingAfterFailedUpdate=!1;