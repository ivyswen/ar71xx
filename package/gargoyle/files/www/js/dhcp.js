/*
 * This program is copyright ï¿½ 2008-2010 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function saveChanges(){errorList=proofreadAll();if(errorList.length>0)errorString=errorList.join("\n")+"\n\nChanges could not be applied.",alert(errorString);else{setControlsEnabled(!1,!0),uci=uciOriginal.clone(),uci.remove("dhcp",dhcpSection,"ignore"),uci.set("dhcp",dhcpSection,"interface","lan"),dhcpIds=["dhcp_start",["dhcp_start","dhcp_end"],"dhcp_lease"],dhcpVisIds=["dhcp_start","dhcp_end","dhcp_lease"],dhcpPkgs=["dhcp","dhcp","dhcp"],dhcpSections=[dhcpSection,dhcpSection,dhcpSection],dhcpOptions=["start","limit","leasetime"],dhcpFunctions=[setVariableFromValue,setVariableFromCombined,setVariableFromModifiedValue],limitParams=[!1,function(e){return parseInt(e[1])-parseInt(e[0])}],leaseParams=[!1,function(e){return e+"h"}],dhcpParams=[!1,limitParams,leaseParams],setVariables(dhcpIds,dhcpVisIds,uci,dhcpPkgs,dhcpSections,dhcpOptions,dhcpFunctions,dhcpParams),dhcpWillBeEnabled=!0,document.getElementById("dhcp_enabled").checked?uci.remove("dhcp","lan","ignore"):(uci.set("dhcp","lan","ignore","1"),dhcpWillBeEnabled=!1),staticIpTable=document.getElementById("staticip_table_container").firstChild,tableData=getTableDataArray(staticIpTable,!0,!1),createEtherCommands=["touch /etc/ethers","rm /etc/ethers"],staticIpTableData=new Array;for(rowIndex in tableData)rowData=tableData[rowIndex],createEtherCommands.push('echo "'+rowData[1].toLowerCase()+"	"+rowData[2]+'" >> /etc/ethers'),staticIpTableData.push([rowData[0],rowData[1],rowData[2]]),rowData[0]!="-"&&(ipHostHash[rowData[2]]=rowData[0]);createHostCommands=["touch /etc/hosts","rm /etc/hosts"];for(ip in ipHostHash)host=ipHostHash[ip],createHostCommands.push('echo "'+ip+"	"+host+'" >> /etc/hosts');var e=[],t=uci.getAllSectionsOfType("firewall","defaults"),n=uciOriginal.get("firewall",t[0],"block_static_ip_mismatches")=="1"?!0:!1,r=document.getElementById("block_mismatches").checked;r!=n&&(r?(uci.set("firewall",t[0],"block_static_ip_mismatches","1"),e.push("uci set firewall.@defaults[0].block_static_ip_mismatches=1")):(uci.remove("firewall",t[0],"block_static_ip_mismatches"),e.push("uci del firewall.@defaults[0].block_statip_mismatches")),e.push("uci commit"));var i="\n/etc/init.d/dnsmasq restart ; \nsh /usr/lib/gargoyle/restart_firewall.sh\n";commands=uci.getScriptCommands(uciOriginal)+"\n"+createEtherCommands.join("\n")+"\n"+createHostCommands.join("\n")+"\n"+e.join("\n")+"\n"+i;var s=getParameterDefinition("commands",commands)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),o=function(e){e.readyState==4&&(uciOriginal=uci.clone(),dhcpEnabled=dhcpWillBeEnabled,dhcpWillBeEnabled=null,resetData(),setControlsEnabled(!0))};runAjax("POST","utility/run_commands.sh",s,o)}}function createEditButton(){var e=createInput("button");return e.value="Edit",e.className="default_button",e.onclick=editStatic,e}function resetData(){dhcpEnabled=uciOriginal.get("dhcp","lan","ignore")=="1"?!1:!0;var e=0;for(e=0;e<staticIpTableData.length;e++){var t=staticIpTableData[e];t.push(createEditButton()),staticIpTableData[e]=t}columnNames=["Hostname","MAC","IP",""],staticIpTable=createTable(columnNames,staticIpTableData,"static_ip_table",!0,!1,resetHostnameMacList),tableContainer=document.getElementById("staticip_table_container"),tableContainer.firstChild!=null&&tableContainer.removeChild(tableContainer.firstChild),tableContainer.appendChild(staticIpTable),dhcpIds=["dhcp_start","dhcp_end","dhcp_lease"],dhcpPkgs=["dhcp",["dhcp","dhcp"],"dhcp"],dhcpSections=[dhcpSection,[dhcpSection,dhcpSection],dhcpSection],dhcpOptions=["start",["start","limit"],"leasetime"],enabledTest=function(e){return e!=1},endCombineFunc=function(e){return parseInt(e[0])+parseInt(e[1])},leaseModFunc=function(e){var t;return e.match(/.*h/)?t=e.substr(0,e.length-1):e.match(/.*m/)?t=e.substr(0,e.length-1)/60:e.match(/.*s/)&&(t=e.substr(0,e.length-1)/3600),t},dhcpParams=[100,[endCombineFunc,150],[12,leaseModFunc]],dhcpFunctions=[loadValueFromVariable,loadValueFromMultipleVariables,loadValueFromModifiedVariable],loadVariables(uciOriginal,dhcpIds,dhcpPkgs,dhcpSections,dhcpOptions,dhcpParams,dhcpFunctions),document.getElementById("dhcp_enabled").checked=dhcpEnabled,setEnabled(document.getElementById("dhcp_enabled").checked);var n=uciOriginal.getAllSectionsOfType("firewall","defaults"),r=uciOriginal.get("firewall",n[0],"block_static_ip_mismatches")=="1"?!0:!1;document.getElementById("block_mismatches").checked=r,resetHostnameMacList()}function resetHostnameMacList(){var e=document.getElementById("staticip_table_container").firstChild,t=e==null?[]:getTableDataArray(e,!0,!1),n=[],r=0;for(r=0;r<t.length;r++){var i=t[r][1].toUpperCase();n[i]=1}var s=["none"],o=["Select Hostname/MAC From Currently Connected Hosts"],u=0;for(u=0;u<leaseData.length;u++){var a=leaseData[u],i=a[0].toUpperCase();n[i]==null&&(s.push(a[2]+","+i),o.push((a[2]==""||a[2]=="*"?a[1]:a[2])+" ("+i+")"))}setAllowableSelections("static_from_connected",s,o);var f=o.length>1&&document.getElementById("dhcp_enabled").checked?!0:!1;setElementEnabled(document.getElementById("static_from_connected"),f,"none")}function staticFromConnected(){var e=getSelectedValue("static_from_connected");if(e!="none"){var t=e.split(/,/)[0],n=e.split(/,/)[1];document.getElementById("add_host").value=t,document.getElementById("add_mac").value=n,setSelectedValue("static_from_connected","none")}}function setEnabled(e){var t=["dhcp_start","dhcp_end","dhcp_lease","block_mismatches","add_host","add_mac","add_ip","add_button"],n;for(n in t){var r=document.getElementById(t[n]);setElementEnabled(r,e,"")}var i=document.getElementById("staticip_table_container").firstChild;setRowClasses(i,e),resetHostnameMacList()}function addStatic(){errors=proofreadStatic(document);if(errors.length>0)alert(errors.join("\n")+"\n\nCould not add row.");else{values=new Array,ids=["add_host","add_mac","add_ip"];for(idIndex in ids)v=document.getElementById(ids[idIndex]).value,v=v==""?"-":v,values.push(v),document.getElementById(ids[idIndex]).value="";values.push(createEditButton()),staticIpTable=document.getElementById("staticip_table_container").firstChild,addTableRow(staticIpTable,values,!0,!1,resetHostnameMacList),resetHostnameMacList()}}function proofreadStatic(e,t,n){e=e==null?document:e,t=t==null?document:t,addIds=["add_mac","add_ip"],labelIds=["add_mac_label","add_ip_label"],functions=[validateMac,validateIP],returnCodes=[0,0],visibilityIds=addIds,errors=proofreadFields(addIds,labelIds,functions,returnCodes,visibilityIds,e);if(errors.length==0){var r=t.getElementById("staticip_table_container").firstChild,i=getTableDataArray(r,!0,!1),s=0;for(s=0;s<i.length;s++)r.rows[s+1]!=n&&(rowData=i[s],rowData[0]!=""&&rowData[0]!="-"&&rowData[0]==e.getElementById("add_host").value&&errors.push("duplicate Hostname"),rowData[1]==e.getElementById("add_mac").value&&errors.push("duplicate MAC"),rowData[2]==e.getElementById("add_ip").value&&errors.push("duplicate IP address"))}if(errors.length==0){var o=getDhcpSection(uciOriginal),u=uciOriginal.get("network","lan","netmask"),a=uciOriginal.get("network","lan","ipaddr"),f=e.getElementById("add_ip").value,l=parseInt(f.split(".")[3]);rangeInSubnet(u,a,l,l)||errors.push("Specified static IP falls outside LAN subnet."),a==f&&errors.push("Specified static IP is current router IP.")}return errors}function proofreadAll(){dhcpIds=["dhcp_start","dhcp_end","dhcp_lease"],labelIds=["dhcp_start_label","dhcp_end_label","dhcp_lease_label"],functions=[validateNumeric,validateNumeric,validateNumeric],returnCodes=[0,0,0],visibilityIds=dhcpIds,errors=proofreadFields(dhcpIds,labelIds,functions,returnCodes,visibilityIds);if(errors.length==0&&document.getElementById("dhcp_enabled").checked){var e=getDhcpSection(uciOriginal),t=uciOriginal.get("network","lan","netmask"),n=uciOriginal.get("network","lan","ipaddr"),r=parseInt(document.getElementById("dhcp_start").value),i=parseInt(document.getElementById("dhcp_end").value);rangeInSubnet(t,n,r,i)||errors.push("Specified DHCP range falls outside LAN subnet.");var s=parseInt(n.split(".")[3]);s>=r&&s<=i&&errors.push("Specified DHCP range contains current LAN IP.")}return errors}function editStatic(){if(typeof editStaticWindow!="undefined")try{editStaticWindow.close()}catch(e){}try{xCoor=window.screenX+225,yCoor=window.screenY+225}catch(e){xCoor=window.left+225,yCoor=window.top+225}editStaticWindow=window.open("static_ip_edit.sh","edit","width=560,height=180,left="+xCoor+",top="+yCoor),saveButton=createInput("button",editStaticWindow.document),closeButton=createInput("button",editStaticWindow.document),saveButton.value="Close and Apply Changes",saveButton.className="default_button",closeButton.value="Close and Discard Changes",closeButton.className="default_button",editRow=this.parentNode.parentNode,runOnEditorLoaded=function(){updateDone=!1,editStaticWindow.document!=null&&editStaticWindow.document.getElementById("bottom_button_container")!=null&&(editStaticWindow.document.getElementById("bottom_button_container").appendChild(saveButton),editStaticWindow.document.getElementById("bottom_button_container").appendChild(closeButton),editStaticWindow.document.getElementById("add_host").value=editRow.childNodes[0].firstChild.data,editStaticWindow.document.getElementById("add_mac").value=editRow.childNodes[1].firstChild.data,editStaticWindow.document.getElementById("add_ip").value=editRow.childNodes[2].firstChild.data,editStaticWindow.document.getElementById("add_button").style.display="none",closeButton.onclick=function(){editStaticWindow.close()},saveButton.onclick=function(){var e=proofreadStatic(editStaticWindow.document,document,editRow);e.length>0?alert(e.join("\n")+"\nCould not update static ip."):(editRow.childNodes[0].firstChild.data=editStaticWindow.document.getElementById("add_host").value,editRow.childNodes[1].firstChild.data=editStaticWindow.document.getElementById("add_mac").value,editRow.childNodes[2].firstChild.data=editStaticWindow.document.getElementById("add_ip").value,editStaticWindow.close(),resetHostnameMacList())},editStaticWindow.moveTo(xCoor,yCoor),editStaticWindow.focus(),updateDone=!0),updateDone||setTimeout("runOnEditorLoaded()",250)},runOnEditorLoaded()};