/*
 * This program is copyright 2008-2012 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function stopInterval(){updateInterval!=null&&clearInterval(updateInterval)}function trim(e){return e?e.replace(/^\s\s*/,"").replace(/\s\s*$/,""):e}function BandwidthCookieContainer(){this.prefix="gargoyle.bandwidth_display.",this.set=function(e,t){var n=new Date((new Date).getTime()+864e7);document.cookie=this.prefix+e+"="+escape(t)+";expires="+n.toUTCString()},this.remove=function(e){var t=new Date(0);document.cookie=this.prefix+e+";expires="+t.toUTCString()},this.get=function(e,t){var n=document.cookie.split(";");for(var r=0;r<n.length;r++){var i=n[r].split("=");if(trim(i[0])==this.prefix+e)return trim(i[1])}return t}}function initializePlotsAndTable(){var e=bandwidthSettings.get("plot_time_frame","1"),t=bandwidthSettings.get("table_time_frame","1");setSelectedValue("plot_time_frame",e),setSelectedValue("table_time_frame",t),setSelectedValue("table_units","mixed"),document.getElementById("use_high_res_15m").checked=uciOriginal.get("gargoyle","bandwidth_display","high_res_15m")=="1"?!0:!1;var n=!1,r=!1,i=!1,s=!1,o;for(o=0;o<monitorNames.length;o++){var u=monitorNames[o];if(u.match(/qos/)){var a=u.match(/up/),f=u.match(/down/);n=n||a,r=r||f;var l=u.split("-");l.shift(),l.shift(),l.pop(),l.pop();var c=l.join("-"),h=uciOriginal.get("qos_gargoyle",c,"name");a&&definedUploadClasses[c]==null&&(qosUploadClasses.push(c),qosUploadNames.push(h),definedUploadClasses[c]=1),f&&definedDownloadClasses[c]==null&&(qosDownloadClasses.push(c),qosDownloadNames.push(h),definedDownloadClasses[c]=1)}i=u.match(/tor/)?!0:i,s=u.match(/openvpn/)?!0:s}var p=["plot1_type","plot2_type","plot3_type","table_type"],d;for(d=0;d<p.length;d++){var v=p[d];n&&addOptionToSelectElement(v,"QoS Upload Class","qos-upload"),r&&addOptionToSelectElement(v,"QoS Download Class","qos-download"),i&&addOptionToSelectElement(v,"Tor","tor"),s&&addOptionToSelectElement(v,"OpenVPN","openvpn"),addOptionToSelectElement(v,"Hostname","hostname"),addOptionToSelectElement(v,"IP","ip");var m=bandwidthSettings.get(v,"none");setSelectedValue(v,m)}plotsInitializedToDefaults=!1,uploadMonitors=["","",""],downloadMonitors=["","",""],updateInProgress=!1,setTimeout(resetPlots,150),updateInterval=setInterval(doUpdate,2e3)}function getEmbeddedSvgPlotFunction(e,t){return t==null&&(t=document),windowElement=getEmbeddedSvgWindow(e,t),windowElement!=null?windowElement.plotAll:null}function getMonitorId(e,t,n,r,i){var s,o=null,u="",a="",f=uciOriginal.get("gargoyle","bandwidth_display","high_res_15m");t=t==1&&n!="total"&&!n.match(/tor/)&&!n.match(/openvpn/)&&f=="1"&&!i?0:t;if(n=="total")u=i?"bdist"+t:"total"+t;else if(n.match(/qos/))e&&n.match(/up/)||!e&&n.match(/down/)?(u="qos"+t,a=r):n="none";else if(n.match(/tor/))u=i?"tor-lr"+t:"tor-hr"+t;else if(n.match(/openvpn/))u=i?"openvpn-lr"+t:"openvpn-hr"+t;else if(n=="ip"||n=="hostname")u="bdist"+t;if(n!="none")for(s=0;s<monitorNames.length&&o==null;s++){var l=monitorNames[s];(l.match("up")&&e||l.match("down")&&!e)&&(u==""||l.match(u))&&(a==""||l.match(a))&&(o=l)}return o}function getHostnameList(e){var t=[],n=0;for(n=0;n<e.length;n++){var r=e[n],i=ipToHostname[r]==null?r:ipToHostname[r];i=i.length<25?i:i.substr(0,22)+"...",t.push(i)}return t}function resetPlots(){if(!updateInProgress&&updateTotalPlot!=null&&updateUploadPlot!=null&&updateDownloadPlot!=null){updateInProgress=!0;var e=tableDownloadMonitor,t=tableUploadMonitor,n=downloadMonitors.join("\n")+"\n",r=uploadMonitors.join("\n");uploadMonitors=[],downloadMonitors=[];var i=getSelectedValue("plot_time_frame"),s=getSelectedValue("table_time_frame"),o=!1,u;for(u=1;u<=3;u++){var a=getSelectedValue("plot"+u+"_type"),f=i==1&&uciOriginal.get("gargoyle","bandwidth_display","high_res_15m")=="1";o=o||a!="total"&&a!="none"&&a!="tor"&&a!="openvpn"&&!f}for(u=1;u<=4;u++){var l=u<4?"plot"+u+"_id":"table_id",c=u<4?l:l+"_container",h=u<4?"plot"+u+"_type":"table_type",p=getSelectedValue(h),d=getSelectedValue(l);d=d==null?"":d,p=="ip"||p=="hostname"?(d.match(/^[0-9]+\./)==null&&(p=="hostname"?setAllowableSelections(l,ipsWithData,getHostnameList(ipsWithData)):setAllowableSelections(l,ipsWithData,ipsWithData),setSelectedValue(l,ipsWithData[0]),d=ipsWithData[0]==null?"":ipsWithData[0]),document.getElementById(c).style.display="block"):p=="qos-upload"?(definedUploadClasses[d]==null&&(setAllowableSelections(l,qosUploadClasses,qosUploadNames),d=qosUploadClasses[0]),document.getElementById(c).style.display="block"):p=="qos-download"?(definedDownloadClasses[d]==null&&(setAllowableSelections(l,qosDownloadClasses,qosDownloadNames),d=qosDownloadClasses[0]),document.getElementById(c).style.display="block"):document.getElementById(c).style.display="none";if(!plotsInitializedToDefaults&&p!=""&&p!="none"&&p!="total"&&p!="tor"&&p!="openvpn"){var v=bandwidthSettings.get(l,"none");v!=""&&(p=="ip"||p=="hostname")&&setAllowableSelections(l,[v],[v]),setSelectedValue(l,v),d=v}if(u!=4)uploadMonitors[u-1]=getMonitorId(!0,i,p,d,o),downloadMonitors[u-1]=getMonitorId(!1,i,p,d,o),uploadMonitors[u-1]=uploadMonitors[u-1]==null?"":uploadMonitors[u-1],downloadMonitors[u-1]=downloadMonitors[u-1]==null?"":downloadMonitors[u-1];else{var m=p=="total"&&s==4?!1:!0;s=m?s:5,tableUploadMonitor=getMonitorId(!0,s,p,d,m),tableDownloadMonitor=getMonitorId(!1,s,p,d,m),tableUploadMonitor=tableUploadMonitor==null?"":tableUploadMonitor,tableDownloadMonitor=tableDownloadMonitor==null?"":tableDownloadMonitor}}plotsInitializedToDefaults=!0,updateInProgress=!1,(r!=uploadMonitors.join("\n")||n!=downloadMonitors.join("\n")||t!=tableUploadMonitor||e!=tableDownloadMonitor)&&doUpdate(),bandwidthSettings.set("plot_time_frame",getSelectedValue("plot_time_frame")),bandwidthSettings.set("table_time_frame",getSelectedValue("table_time_frame"));for(u=1;u<=4;u++){var l=u<4?"plot"+u+"_id":"table_id",h=u<4?"plot"+u+"_type":"table_type",p=getSelectedValue(h);bandwidthSettings.set(h,p),p!=""&&p!="none"&&p!="total"?bandwidthSettings.set(l,getSelectedValue(l)):(bandwidthSettings.remove(l),bandwidthSettings.remove(h))}}else{setTimeout(resetPlots,25);if(updateTotalPlot==null||updateDownloadPlot==null||updateUploadPlot==null)updateTotalPlot=getEmbeddedSvgPlotFunction("total_plot"),updateDownloadPlot=getEmbeddedSvgPlotFunction("download_plot"),updateUploadPlot=getEmbeddedSvgPlotFunction("upload_plot")}}function parseMonitors(e){var t=[],n=e.split(/[\r\n]+/),r=parseInt(n.shift());if(""+r=="NaN")return t;var i;for(i=0;i<n.length;i++)if(n[i]!=null&&n[i].length>0&&n[i].match(/ /)){var s=n[i].split(/[\t ]+/)[0],o=n[i].split(/[\t ]+/)[1];i++;var u=n[i];i++;var a=n[i];i++;var f=n[i];if(n[i+1]!=null)if(n[i+1].match(/,/)||n[i+1].match(/^[0-9]+$/)){i++;var l=n[i].split(",");t[s]=t[s]==null?[]:t[s],t[s][o]=[l,f,r],found=1}}return t}function getDisplayIp(e){var t=e;return t!=null&&currentWanIp!=null&&currentLanIp!=null&&t!=""&&(t=t==currentWanIp?currentLanIp:t),t}function getRealIp(e){var t=e;return t!=null&&currentWanIp!=null&&currentLanIp!=null&&currentWanIp!=""&&currentLanIp!=""&&t!=""&&(t=t==currentLanIp?currentWanIp:t),t}function doUpdate(){if(!updateInProgress&&updateUploadPlot!=null&&updateDownloadPlot!=null&&updateTotalPlot!=null){updateInProgress=!0;var e=uploadMonitors.join(" ")+" "+downloadMonitors.join(" ")+" "+tableDownloadMonitor+" "+tableUploadMonitor,t=getParameterDefinition("monitor",e)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),n=function(e){if(e.readyState==4){try{clearTimeout(updateTimeoutId)}catch(t){}updateReq=null;if(e.responseText.length>0&&!e.responseText.match(/ERROR/)){var n=parseMonitors(e.responseText),r=[],i=[],s=[],o=[],u=[],a=0,f=2,l=0,c=2,h=Math.floor((new Date).getTime()/1e3),p=h,d=h;for(monitorIndex=0;monitorIndex<4;monitorIndex++){var v=!1,m;for(m=0;m<2;m++){var g=!1,y,b;if(monitorIndex<3){var w=m==0?downloadMonitors:uploadMonitors;y=m==0?i:r,b=w[monitorIndex]}else y=o,b=m==0?tableDownloadMonitor:tableUploadMonitor;b=b==null?"":b;var E=monitorIndex<3?"plot"+(monitorIndex+1)+"_type":"table_type",S=getSelectedValue(E),x=b==""?null:n[b];if(x!=null){var T="",N=[],C;for(C in x)((S=="total"||S.match("qos")||S.match("tor")||S.match("openvpn"))&&C=="COMBINED"||S!="total"&&C!="COMBINED")&&N.push(getDisplayIp(C));if(N.length>0){var k=b.split("-");monitorIndex<3?(a=k.pop(),f=k.pop()):(l=k.pop(),c=k.pop());if(b.match("bdist")&&S!="total"){var L=monitorIndex<3?"plot"+(monitorIndex+1)+"_id":"table_id";C=getSelectedValue(L),C=C==null?"":getRealIp(C),C=x[C]!=null?C:N[0],S=="hostname"?setAllowableSelections(L,N,getHostnameList(N)):setAllowableSelections(L,N,N),ipsWithData=N}else C=N[0];C=C==null?"":getRealIp(C);var A=x[C][0];monitorIndex<3?(h=x[C][1],p=x[C][2]):d=x[C][1];var O;monitorIndex<3?O=s[monitorIndex]==null?[]:s[monitorIndex]:O=u;var M;for(M=0;M<A.length;M++){var _=A.length-(1+M),D=O.length<A.length?M:O.length-A.length+M;O[D]!=null?O[D]=parseInt(O[D])+parseInt(A[_]):O.push(A[_])}monitorIndex<3&&(s[monitorIndex]=O),y.push(A),g=!0}else if(b.match("bdist")&&monitorIndex<3){var E=monitorIndex<3?"plot"+(monitorIndex+1)+"_type":"table_type",L=monitorIndex<3?"plot"+(monitorIndex+1)+"_id":"table_id";w[monitorIndex]="",setSelectedValue(E,"none"),document.getElementById(L).display="none"}}else if(b.match("bdist")&&S!="total"&&monitorIndex<3){var L=monitorIndex<3?"plot"+(monitorIndex+1)+"_id":"table_id";w[monitorIndex]="",setSelectedValue(E,"none"),document.getElementById(L).style.display="none"}g||y.push(null)}monitorIndex<3?s[monitorIndex]=s[monitorIndex]==null?null:s[monitorIndex].reverse():(u.reverse(),o.unshift(u))}updateTotalPlot(s,a,f,h,p,tzMinutes),updateDownloadPlot(i,a,f,h,p,tzMinutes),updateUploadPlot(r,a,f,h,p,tzMinutes);if(expandedFunctions["Total"]!=null){var P=expandedFunctions.Total;P(s,a,f,h,p,tzMinutes)}if(expandedFunctions["Download"]!=null){var P=expandedFunctions.Download;P(i,a,f,h,p,tzMinutes)}if(expandedFunctions["Upload"]!=null){var P=expandedFunctions.Upload;P(r,a,f,h,p,tzMinutes)}updateBandwidthTable(o,c,d)}updateInProgress=!1}},r=function(){updateInProgress=!1};updateReq=runAjax("POST","utility/load_bandwidth.sh",t,n),updateTimeoutId=setTimeout(r,5e3)}}function twod(e){var t=""+e;return t=t.length==1?"0"+t:t,t}function updateBandwidthTable(e,t,n){var r=[],i=0,s=getSelectedValue("table_units"),o=n,u=new Date;u.setTime(o*1e3),u.setUTCMinutes(u.getUTCMinutes()+tzMinutes),parseInt(t)=="NaN"&&(t.match(/month/)||t.match(/day/))&&(u=new Date(u.getTime()+108e5));var a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];for(i=0;i<e[0].length;i++){var f=0,l=[];for(f=0;f<3;f++){var c=e[f],h=c==null?0:c[c.length-(1+i)];h=h==null?0:h,l.push(parseBytes(h,s))}var p="";t.match(/minute/)?(p=""+twod(u.getUTCHours())+":"+twod(u.getUTCMinutes()),u.setUTCMinutes(u.getUTCMinutes()-1)):t.match(/hour/)?(p=""+twod(u.getUTCHours())+":"+twod(u.getUTCMinutes()),u.setUTCHours(u.getUTCHours()-1)):t.match(/day/)?(p=a[u.getUTCMonth()]+" "+u.getUTCDate(),u.setUTCDate(u.getUTCDate()-1)):t.match(/month/)?(p=a[u.getUTCMonth()]+" "+u.getUTCFullYear(),u.setUTCMonth(u.getUTCMonth()-1)):parseInt(t)!="NaN"&&(parseInt(t)>=2419200?p=a[u.getUTCMonth()]+" "+u.getUTCFullYear()+" "+twod(u.getUTCHours())+":"+twod(u.getUTCMinutes()):parseInt(t)>=86400?p=a[u.getUTCMonth()]+" "+twod(u.getUTCHours())+":"+twod(u.getUTCMinutes()):p=""+twod(u.getUTCHours())+":"+twod(u.getUTCMinutes()),u.setTime(u.getTime()-parseInt(t)*1e3)),l.unshift(p),r.push(l),o=u.getTime()/1e3}var d=["Time","Total","Download","Upload"],v=createTable(d,r,"bandwidth_table",!1,!1);tableContainer=document.getElementById("bandwidth_table_container"),tableContainer.firstChild!=null&&tableContainer.removeChild(tableContainer.firstChild),tableContainer.appendChild(v)}function expand(e){var t=expandedWindows[e],n=0,r=0;if(typeof t!="undefined"){try{t.close()}catch(i){}t=null}try{n=window.screenX+225,r=window.screenY+225}catch(i){n=window.left+225,r=window.top+225}t=window.open("bandwidth_expand.sh",e+" Bandwidth Plot","width=850,height=650,left="+n+",top="+r),expandedWindows[e]=t;var s=function(e){var t=!1,n=expandedWindows[e];if(n.document!=null&&n.document.getElementById("bandwidth_plot")!=null){var r=n.document.getElementById("plot_title");r!=null&&(expandedFunctions[e]=getEmbeddedSvgPlotFunction("bandwidth_plot",n.document),expandedFunctions[e]!=null&&(r.appendChild(n.document.createTextNode(e+" Bandwidth Usage")),n.onbeforeunload=function(){expandedFunctions[e]=null,expandedWindows[e]=null},t=!0))}if(!t){var i=function(){s(e)};setTimeout(i,250)}};s(e)}function highResChanged(){setControlsEnabled(!1,!0,"Resetting Graphs...");var e=document.getElementById("use_high_res_15m").checked,t=[];t.push("uci set gargoyle.bandwidth_display=bandwidth_display"),t.push("uci set gargoyle.bandwidth_display.high_res_15m="+(e?"1":"0")),t.push("uci commit"),t.push("/etc/init.d/bwmon_gargoyle restart");var n=function(e){e.readyState==4&&(window.location=window.location,setControlsEnabled(!0))},r=getParameterDefinition("commands",t.join("\n"))+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,""));runAjax("POST","utility/run_commands.sh",r,n)}function deleteData(){if(confirm("Delete all data?")==0)return;setControlsEnabled(!1,!0,"Deleting data ...");var e=[];e.push("/etc/init.d/bwmon_gargoyle stop"),e.push("rm /tmp/data/bwmon/*"),e.push("rm /usr/data/bwmon/*"),e.push("/etc/init.d/bwmon_gargoyle start");var t=function(e){e.readyState==4&&setControlsEnabled(!0)},n=getParameterDefinition("commands",e.join("\n"))+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,""));runAjax("POST","utility/run_commands.sh",n,t)}var ipMonitorIds,qosUploadMonitorIds,qosDownloadMonitorIds,uploadMonitors=null,downloadMonitors=null,tableUploadMonitor=null,tableDownloadMonitor=null,ipsWithData=[],qosDownloadClasses=[],qosDownloadNames=[],qosUploadClasses=[],qosUploadNames=[],definedUploadClasses=[],definedDownloadClasses=[],updateTotalPlot=null,updateUploadPlot=null,updateDownloadPlot=null,updateInProgress=!1,plotsInitializedToDefaults=!1,expandedWindows=[],expandedFunctions=[],updateInterval=null;window.onbeforeunload=stopInterval,bandwidthSettings=new BandwidthCookieContainer;var updateReq=null,updateTimeoutId=null;