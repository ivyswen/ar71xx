/*
 * This program is copyright ï¿½ 2008-2010 Eric Bishop and is distributed under the terms of the GNU GPL 
 * version 2.0 with a special clarification/exception that permits adapting the program to 
 * configure proprietary "back end" software provided that all modifications to the web interface
 * itself remain covered by the GPL. 
 * See http://gargoyle-router.com/faq.html#qfoss for more information
 */function resetData(){allQuotaIds=quotaIdList,allQuotaIps=quotaIpLists,allQuotaUsed=quotaUsed,allQuotaLimits=quotaLimits,allQuotaPercents=quotaPercents,idToSection=[],idToIpStr=[],idToTimeParams=[];var e=uciOriginal.getAllSectionsOfType(pkg,"quota"),t;for(t=0;t<e.length;t++){var n=getIpFromUci(uciOriginal,e[t]),r=uciOriginal.get(pkg,e[t],"id");r=r==""?getIdFromIp(n,uciOriginal):r,idToSection[r]=e[t],idToIpStr[r]=n,idToTimeParams[r]=getTimeParametersFromUci(uciOriginal,e[t])}refreshTableData(),setInterval("updateTableData()",1500)}function getIpFromUci(e,t){var n=e.get(pkg,t,"ip");if(n=="ALL_OTHERS_INDIVIDUAL")n="Others (Individual)";else if(n=="ALL_OTHERS_COMBINED")n="Others (Combined)";else if(n=="ALL"||n=="")n="All";return n}function getIdFromIp(e,t){id=e==""?"ALL":e.replace(/[\t, ]+.*$/,""),id=id.replace(/\//,"_");var n=id,r=!0,i=0,s=t.getAllSectionsOfType(pkg,"quota");while(r){r=!1;var o;for(o=0;o<s.length&&!r;o++)r=r||t.get(pkg,s[o],"id")==id;if(r){var u="ABCDEFGHIJKLMNOPQRSTUVWXYZ",a=i<26?"_"+u.substr(i,1):"_Z"+(i-25);id=n+a}i++}return id}function getTimeParametersFromUci(e,t){var n=e.get(pkg,t,"offpeak_hours"),r=e.get(pkg,t,"offpeak_weekdays"),i=e.get(pkg,t,"offpeak_weekly_ranges"),s=n!=""||r!=""||i!=""?"except":"always";return s=="always"&&(n=e.get(pkg,t,"onpeak_hours"),r=e.get(pkg,t,"onpeak_weekdays"),i=e.get(pkg,t,"onpeak_weekly_ranges"),s=n!=""||r!=""||i!=""?"only":"always"),[n,r,i,s]}function timeParamsToTableSpan(e){var t=e[0],n=e[1],r=e[2],i=e[3],s=[];return i=="always"?s.unshift("Always"):(r!=""?s=r.match(",")?r.split(/[\t ]*,[\t ]*/):[r]:(t!=""&&(s=t.match(",")?t.split(/[\t ]*,[\t ]*/):[t]),n!=""&&s.unshift(n)),s.unshift(i=="only"?"Only:":"All Times Except:")),textListToSpanElement(s,!1,document)}function getHostDisplay(e){var t=getSelectedValue("host_display"),n=e;return t=="hostname"&&ipToHostname[e]!=null&&(n=ipToHostname[e],n=n.length<25?n:n.substr(0,22)+"..."),n}function getHostList(e){var t=[],n=0;for(n=0;n<e.length;n++)t.push(getHostDisplay(e[n]));return t}function refreshTableData(){var e=uciOriginal.getAllSectionsOfType(pkg,"quota"),t=[],n;for(n=0;n<allQuotaIds.length;n++){var r,i=allQuotaIds[n],s=allQuotaIps[i],o=idToTimeParams[i];for(r=0;r<s.length;r++){var u=s[r],a="N/A",f="N/A",l="N/A";if(allQuotaPercents[i]!=null&&allQuotaPercents[i][u]!=null){var c=allQuotaUsed[i][u],h=allQuotaLimits[i][u],p=allQuotaPercents[i][u];l=p[0]>=0?p[0]+"%":l,f=p[1]>=0?p[1]+"%":f,a=p[2]>=0?p[2]+"%":a}ipList=u.split(/[\t ]*,[\t ]*/),hostList=getHostList(ipList),t.push([textListToSpanElement(hostList,!0,document),timeParamsToTableSpan(o),l,f,a])}}var d=["Host(s)","Active","% Total Used","% Down Used","% Up Used"],v=createTable(d,t,"quota_usage_table",!1,!1),m=document.getElementById("quota_table_container");while(m.firstChild!=null)m.removeChild(m.firstChild);m.appendChild(v)}function updateTableData(){if(!updateInProgress){updateInProgress=!0;var command="print_quotas\n",param=getParameterDefinition("commands",command)+"&"+getParameterDefinition("hash",document.cookie.replace(/^.*hash=/,"").replace(/[\t ;]+.*$/,"")),stateChangeFunction=function(req){if(req.readyState==4){var text=req.responseText.split(/[\r\n]+/),next="";while(text.length>0&&next!="Success")next=text.pop();eval(text.join("\n")),allQuotaIds=quotaIdList,allQuotaIps=quotaIpLists,allQuotaUsed=quotaUsed,allQuotaLimits=quotaLimits,allQuotaPercents=quotaPercents,refreshTableData(),updateInProgress=!1}};runAjax("POST","utility/run_commands.sh",param,stateChangeFunction)}}var pkg="firewall",updateInProgress=!1,allQuotaIds,allQuotaIps,allQuotaUsed,allQuotaLimits,allQuotaPercents,idToSection=[],idToIpStr=[],idToTimeParams=[];